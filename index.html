<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV (melhorado)</title>

<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css" />
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" />

<style>
  /* Reset / box model */
  *,*::before,*::after { box-sizing: border-box; }
  html, body {
    margin: 0;
    min-height: 100%;
    height: 100%;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica;
    background: #f5f7fb;
    color: #0b1220;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x: hidden;
    overflow-y: auto;
  }

  :root{
    --sidebar-width: 260px;
    --right-width: 420px;
    --brand: #0f6fb2;
    --muted: #6b7280;
    --bg: #f5f7fb;
    --card: #ffffff;
    --panel-bg: #0f262a;       /* darker teal for panel background */
    --panel-section: #0a1618;  /* inner panel section */
    --panel-card: #0b1416;     /* code card background */
    --accent: #14b8a6;
    --page-gutter: 16px;
  }

  /* ===== LAYOUT ===== */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    gap: 18px;
    min-height: calc(100vh - (var(--page-gutter) * 2));
    padding: var(--page-gutter);
    align-items: start;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    background: var(--card);
    border-right: 1px solid rgba(15,23,42,0.06);
    padding: 14px;
    display:flex;
    flex-direction:column;
    gap:12px;
    position: relative;
    max-height: calc(100vh - (var(--page-gutter) * 2));
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    min-width: 0;
  }

  .brand { display:flex; align-items:center; gap:10px; padding-bottom:6px; border-bottom:1px solid rgba(2,6,23,0.03); }
  .brand-logo { height:40px; width:auto; display:block; }
  .brand-text { font-weight:800; font-size:14px; }

  .sidebar .search input[type="search"] {
    width: 100%;
    padding: 9px 10px;
    border-radius: 8px;
    border: 1px solid rgba(2,6,23,0.06);
    background: #fbfdff;
    font-size: 13px;
    outline: none;
  }

  .nav { margin:0; padding:0; list-style:none; overflow:visible; }

  .menu-section { margin-bottom:8px; }

  .menu-heading { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px; color:var(--muted); font-weight:600; font-size:13px; }
  .menu-heading .count { background: rgba(15,111,178,0.08); color:var(--brand); padding:3px 8px; border-radius:999px; font-size:12px; }

  .tag-item {
    display:block;
    margin-bottom:8px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    color:#0b1220;
    transition: background .12s, transform .06s;
    padding: 8px;
    border: 1px solid transparent;
    text-align: left;
  }
  .tag-item:hover { background: rgba(2,6,23,0.03); transform: translateY(-1px); }
  .tag-item.active { background: linear-gradient(180deg,#f2f8ff,#ffffff); border:1px solid rgba(15,111,178,0.06); box-shadow: 0 6px 18px rgba(12,37,63,0.04); }

  .ops { margin-top:6px; padding-left:4px; display:flex; flex-direction:column; gap:6px; }

  .op-link {
    display:flex;
    gap:10px;
    align-items:center;
    padding:8px;
    border-radius:8px;
    font-size:13px;
    color:#263238;
    background: transparent;
    border: none;
    text-align:left;
    cursor:pointer;
  }
  .op-link:hover { background: rgba(2,6,23,0.03); transform: translateY(-1px); }
  .op-link.active { background: rgba(2,6,23,0.04); box-shadow: inset 3px 0 0 var(--brand); color:#0b1220; font-weight:700; }

  .method-pill-left { padding:6px 10px; border-radius:8px; font-weight:800; font-size:11px; color:#fff; min-width:52px; text-align:center; }
  .method-get { background:#16a34a; }
  .method-post { background:#0ea5e9; }
  .method-put { background:#f59e0b; color:#0b1220; }
  .method-delete { background:#ef4444; }

  /* ===== CONTENT (central) ===== */
  .content {
    min-width: 0;
    max-height: calc(100vh - (var(--page-gutter) * 2));
    overflow: auto;
    -webkit-overflow-scrolling: touch;
  }

  .swagger-ui {
    background: var(--card);
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 8px 24px rgba(9,30,66,0.06);
    color: #0b1220;
    width: 100%;
    min-width: 0;
    max-height: calc(100vh - (var(--page-gutter) * 2) - 12px);
    overflow: auto;
  }

  /* Top H2 container moved by script */
  .swagger-top-h2s { margin: 8px 0 18px 0; padding-left: 6px; }
  .swagger-top-h2s h2.moved-h2 {
    font-size: 20px;
    margin: 4px 0 12px 0;
    font-weight: 800;
    color: #0b1220;
    line-height: 1.15;
  }

  /* make swagger internals predictable */
  .swagger-ui .wrapper, .swagger-ui .info, .swagger-ui .opblock, .swagger-ui .block, .swagger-ui .content {
    width: 100% !important;
    max-width: 100% !important;
  }

  .swagger-ui .opblock .opblock-summary-path,
  .swagger-ui .opblock .opblock-summary-method,
  .swagger-ui .opblock pre,
  .swagger-ui .opblock code,
  .swagger-ui .opblock .opblock-title,
  .swagger-ui .markdown {
    word-break: break-word;
    white-space: normal !important;
  }

  .swagger-ui .opblock { border: none; box-shadow: none; margin-bottom: 12px; }

  /* ===== RIGHT PANEL - NEW DARK LAYOUT (matches provided screenshot) ===== */
  .code-panel {
    background: var(--panel-bg);
    border-left: 1px solid rgba(255,255,255,0.03);
    padding: 14px;
    color: #e6fbf4;
    display:flex;
    flex-direction:column;
    gap:12px;
    position: sticky;
    top: var(--page-gutter);
    align-self: start;
    max-height: calc(100vh - (var(--page-gutter) * 2));
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    min-width: 0;
    border-radius: 6px;
  }

  /* Header bar with try/method/path (dark) */
  .panel-header {
    background: rgba(0,0,0,0.25);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .panel-header .try-badge {
    background:#2c7; /* light but subtle - will be adjusted by method color visually */
    background: #6a9fb0;
    color: #eaf6f5;
    padding: 4px 8px;
    border-radius:4px;
    font-weight:700;
    font-size:12px;
    text-transform:lowercase;
  }
  .panel-header .method-pill {
    padding:6px 10px;
    border-radius:6px;
    font-weight:800;
    font-size:12px;
    color:#fff;
  }
  .panel-header .method-pill.get { background:#16a34a; }
  .panel-header .method-pill.post { background:#0ea5e9; }
  .panel-header .method-pill.put { background:#f59e0b; color:#0b1220; }
  .panel-header .method-pill.delete { background:#ef4444; }

  .panel-header .path {
    margin-left: 6px;
    color:#e6fbf4;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    font-size: 13px;
    opacity: 0.95;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Section (Request/Response) */
  .panel-section {
    background: transparent;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .panel-section h3 {
    margin:0;
    font-size:16px;
    color:#e6fbf4;
  }

  /* Code card: dark inner box */
  .code-card {
    background: var(--panel-card);
    border: 1px solid rgba(255,255,255,0.03);
    border-radius: 6px;
    overflow: hidden;
  }

  .code-card .content-type {
    background: rgba(255,255,255,0.03);
    color: #9bdacb;
    padding: 8px 12px;
    font-size: 13px;
    border-bottom: 1px solid rgba(255,255,255,0.02);
  }

  .code-card .code-area {
    padding: 12px;
    color: #9be1cc;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;
    font-size: 13px;
    white-space: pre-wrap;
    word-break: break-word;
    overflow: auto;
    max-height: 320px;
  }

  .code-card .code-area pre {
    margin: 0;
    background: transparent;
    color: #9be1cc;
    white-space: pre-wrap;
  }

  /* controls within top-right of code card */
  .code-card .card-controls {
    display:flex;
    gap:10px;
    justify-content:flex-end;
    align-items:center;
    padding: 8px 12px;
    font-size:13px;
    color: #bcded6;
  }
  .code-card .card-controls button {
    background: transparent;
    border: none;
    color: #bcded6;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight:600;
  }
  .code-card .card-controls button:hover { background: rgba(255,255,255,0.02); }

  /* Response code badges row */
  .response-codes {
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .response-codes .code-badge {
    background: #0f2e2f;
    color: #9be1cc;
    padding: 6px 10px;
    border-radius: 6px;
    font-weight:700;
    cursor:pointer;
    border: 1px solid rgba(255,255,255,0.02);
  }
  .response-codes .code-badge.active {
    background: linear-gradient(90deg,#1f9aa0,#2db4a6);
    color: #041417;
  }

  /* Small helpers */
  .panel-small {
    color: #9bdacb;
    font-size: 13px;
  }

  /* Responsividade */
  @media (max-width: 1200px) {
    .layout { grid-template-columns: 1fr; grid-template-rows: auto 1fr; padding: 12px; }
    .code-panel { display: none; }
    .sidebar { max-height: none; overflow: visible; position: relative; }
    .content { max-height: none; overflow: visible; }
    .swagger-ui { max-height: none; overflow: visible; padding: 16px; }
  }

</style>
</head>
<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Sidebar">
    <div class="brand" aria-hidden="false">
      <img src="https://developers-sandbox.bvopen.com.br/sites/default/files/apidoc_specs/API-PIX-V1/assets/images/logo.png" alt="Banco BV" class="brand-logo" />
      <div>
        <div class="brand-text">Banco BV</div>
      </div>
    </div>

    <div class="search" aria-hidden="false">
      <input id="sidebar-search" type="search" placeholder="Buscar endpoints, tags, títulos..." aria-label="Buscar" />
    </div>

    <nav>
      <ul id="sidebar-menu" class="nav" aria-live="polite" aria-label="Lista de tags"></ul>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="content">
    <div id="swagger-ui" class="swagger-ui"></div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <!-- header bar (try / method / path) -->
    <div id="panel-header" class="panel-header" aria-hidden="false">
      <div class="try-badge">try</div>
      <div id="code-method" class="method-pill default">OP</div>
      <div id="code-path" class="path">/caminho/exemplo</div>
    </div>

    <!-- Request samples -->
    <div id="request-section" class="panel-section" aria-hidden="false" style="display:none;">
      <h3>Request samples</h3>
      <div class="code-card" id="request-card">
        <div class="content-type" id="request-content-type">application/json</div>
        <div class="card-controls" id="request-controls">
          <button id="request-copy">Copy</button>
          <button id="request-expand">Expand all</button>
          <button id="request-collapse">Collapse all</button>
        </div>
        <div class="code-area" id="request-code-area"><pre><code></code></pre></div>
      </div>
    </div>

    <!-- Response samples -->
    <div id="response-section" class="panel-section" aria-hidden="false" style="display:none;">
      <h3>Response samples</h3>
      <div class="response-codes" id="response-codes"></div>
      <div class="code-card" id="response-card" style="margin-top:6px;">
        <div class="content-type" id="response-content-type">application/json</div>
        <div class="card-controls" id="response-controls">
          <button id="response-copy">Copy</button>
          <button id="response-expand">Expand all</button>
          <button id="response-collapse">Collapse all</button>
        </div>
        <div class="code-area" id="response-code-area"><pre><code></code></pre></div>
      </div>
    </div>

  </aside>

</div>

<!-- scripts -->
<script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<script>
/*
  Enhanced right panel presentation:
  - New dark header bar (try + method + path)
  - Structured "Request samples" and "Response samples" sections
  - Copy / Expand / Collapse controls per section
  - Response code badges to switch displayed example
  - Attempts to extract request example(s) and response example(s) from the opblock.
  - Graceful fallbacks when examples are not present.
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";
let lastClickedOpblock = null;
let responseExamples = []; // {status, contentType, text}
let requestExample = null;  // {contentType, text}

// Initialize Swagger UI
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true,
  presets: [SwaggerUIBundle.presets.apis]
});

// helpers
const $qs = (s, scope = document) => (scope || document).querySelector(s);
const $qsa = (s, scope = document) => Array.from((scope || document).querySelectorAll(s));

function waitForSwaggerReady(timeout = 15000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function check() {
      if ($qsa('.opblock-summary').length > 0 || $qsa('#swagger-ui h2').length > 0) return resolve();
      if (Date.now() - start > timeout) return reject(new Error('Swagger UI did not render in time'));
      requestAnimationFrame(check);
    })();
  });
}

/* Move floating H2s into top container */
function relocateH2s() {
  const ui = document.getElementById('swagger-ui');
  if (!ui) return;
  let container = ui.querySelector('.swagger-top-h2s');
  if (!container) {
    container = document.createElement('div');
    container.className = 'swagger-top-h2s';
    const info = ui.querySelector('.info');
    if (info && info.parentNode) info.parentNode.insertBefore(container, info.nextSibling);
    else ui.insertBefore(container, ui.firstChild);
  }

  const h2s = Array.from(ui.querySelectorAll('h2'));
  h2s.forEach(h2 => {
    if (container.contains(h2)) return;
    if (h2.closest('.opblock') || h2.closest('.swagger-top-h2s')) return;
    container.appendChild(h2);
    h2.classList.add('moved-h2');
  });
}

/* Build sidebar (H2 + tags + ops) */
function buildSidebar() {
  const menu = document.getElementById('sidebar-menu');
  if (!menu) return;
  menu.innerHTML = '';

  const h2s = $qsa('#swagger-ui h2');
  if (h2s.length) {
    const section = document.createElement('li');
    section.className = 'menu-section';
    section.innerHTML = `<div class="menu-heading"><div style="font-weight:700">Seções</div><div class="count">${h2s.length}</div></div>`;
    const list = document.createElement('div');
    list.style.display = 'flex';
    list.style.flexDirection = 'column';
    list.style.gap = '6px';
    h2s.forEach(h2 => {
      const text = (h2.textContent || '').trim();
      const btn = document.createElement('button');
      btn.className = 'tag-item';
      btn.type = 'button';
      btn.innerHTML = `<strong>${escapeHtml(text)}</strong>`;
      btn.addEventListener('click', () => {
        h2.scrollIntoView({ behavior: 'smooth', block: 'center' });
        Array.from(menu.querySelectorAll('.tag-item')).forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
      });
      list.appendChild(btn);
    });
    section.appendChild(list);
    menu.appendChild(section);
  }

  const tags = $qsa('.opblock-tag');
  tags.forEach(tagEl => {
    const titleSpan = tagEl.querySelector('h3 span');
    if (!titleSpan) return;
    const titleText = titleSpan.textContent.trim();

    const operations = tagEl.querySelectorAll('.opblock-summary');
    const count = operations.length;

    const li = document.createElement('li');
    li.className = 'menu-section';

    const head = document.createElement('div');
    head.className = 'menu-heading';
    head.innerHTML = `<div style="font-weight:700">${escapeHtml(titleText)}</div><div class="count">${count}</div>`;
    li.appendChild(head);

    const opsContainer = document.createElement('div');
    opsContainer.className = 'ops';

    operations.forEach(op => {
      const method = op.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
      const path = op.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
      const btn = document.createElement('button');
      btn.className = 'op-link';
      btn.type = 'button';
      btn.innerHTML = `<div class="method-pill-left method-${method.toLowerCase()}">${escapeHtml(method)}</div>
                       <div style="display:flex;flex-direction:column;align-items:flex-start;">
                         <div style="font-size:13px;color:#0b1220;">${escapeHtml(path)}</div>
                       </div>`;

      btn.addEventListener('click', () => {
        const opblock = op.closest('.opblock');
        if (!opblock) return;
        const summary = opblock.querySelector('.opblock-summary');
        if (summary) {
          summary.scrollIntoView({ behavior: 'smooth', block: 'center' });
          summary.click();
          lastClickedOpblock = opblock;
          setTimeout(() => updateRightPanel(opblock), 260);
        }
      });

      opsContainer.appendChild(btn);
    });

    li.appendChild(opsContainer);

    head.addEventListener('click', () => {
      const isActive = li.classList.contains('active');
      Array.from(menu.children).forEach(n => n.classList.remove('active'));
      if (!isActive) li.classList.add('active');
      tagEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    menu.appendChild(li);
  });
}

/* Basic search */
function wireSearch() {
  const input = document.getElementById('sidebar-search');
  if (!input) return;
  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    const items = $qsa('#sidebar-menu .menu-section');
    items.forEach(item => {
      const heading = item.querySelector('.menu-heading > div')?.textContent?.toLowerCase() || '';
      const ops = Array.from(item.querySelectorAll('.op-link'));
      let anyOpMatch = false;
      ops.forEach(op => {
        const txt = op.textContent.toLowerCase();
        const match = q === '' || txt.includes(q);
        op.style.display = match ? '' : 'none';
        if (match) anyOpMatch = true;
      });
      const sectionMatch = q === '' || heading.includes(q);
      item.style.display = (sectionMatch || anyOpMatch) ? '' : 'none';
    });
  });
}

/* Capture clicks on opblocks */
function bindGlobalOpClicks() {
  document.addEventListener('click', (e) => {
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    lastClickedOpblock = opblock;
    setTimeout(() => updateRightPanel(opblock), 200);
  });

  document.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    lastClickedOpblock = opblock;
    setTimeout(() => updateRightPanel(opblock), 200);
  });
}

/* Observe swagger render & rebuild sidebar + relocate h2s */
function observeSwagger() {
  const uiRoot = document.querySelector('#swagger-ui');
  if (!uiRoot) return;
  const mo = new MutationObserver(mutations => {
    let shouldRebuild = false;
    for (const m of mutations) {
      if (m.addedNodes && m.addedNodes.length) shouldRebuild = true;
      if (m.type === 'attributes' && m.attributeName === 'class') {
        const t = m.target;
        if (t.classList && t.classList.contains('opblock') && t.classList.contains('is-open')) {
          const preferred = lastClickedOpblock || t;
          setTimeout(() => updateRightPanel(preferred), 80);
        }
      }
    }
    if (shouldRebuild) {
      clearTimeout(window._rebuild_sidebar);
      window._rebuild_sidebar = setTimeout(() => {
        try {
          relocateH2s();
          buildSidebar();
          wireSearch();
        } catch(e){/*ignore*/ }
      }, 140);
    }
  });

  mo.observe(uiRoot, { subtree: true, childList: true, attributes: true, attributeFilter: ['class'] });
}

/* Try to extract request example from opblock */
function extractRequestExample(opblock) {
  // heuristics - try common places
  const selectors = [
    '.opblock-body .request-body pre',
    '.opblock-body .request-body code',
    '.opblock-body .body-param pre',
    '.opblock-body .body-param code',
    '.opblock-body .parameter__examples pre',
    '.opblock-section .example pre',
    '.opblock-section .example code',
    '.try-out .microlight', // sometimes used
  ];
  for (const sel of selectors) {
    const node = opblock.querySelector(sel);
    if (node) {
      return { contentType: 'application/json', text: node.innerText.trim() };
    }
  }

  // as fallback, check for a request textarea (swagger try it) and read its value
  const textarea = opblock.querySelector('textarea');
  if (textarea && textarea.value.trim()) {
    return { contentType: 'application/json', text: textarea.value.trim() };
  }

  return null;
}

/* Extract response examples from opblock; returns array of {status, contentType, text} */
function extractResponseExamples(opblock) {
  const out = [];

  // try structured responses first
  let responseNodes = opblock.querySelectorAll('.responses-wrapper .response');
  if (!responseNodes || responseNodes.length === 0) {
    responseNodes = opblock.querySelectorAll('.response');
  }

  responseNodes = Array.from(responseNodes);
  // dedupe nodes that are inside other opblocks
  responseNodes = responseNodes.filter(n => opblock.contains(n));

  for (const node of responseNodes) {
    // find status text
    let status = (node.querySelector('.response-col_status')?.textContent ||
                  node.querySelector('.response__status')?.textContent ||
                  node.querySelector('.response-status-code')?.textContent ||
                  node.querySelector('h4')?.textContent ||
                  node.querySelector('.response_status')?.textContent ||
                  '').trim();

    // normalize numeric code using regex
    const m = status.match(/(\d{3})/);
    if (m) status = m[1];
    else {
      // try to find from node heading or label
      const fallback = node.textContent.match(/(^|\s)(\d{3})(\b)/);
      status = fallback ? fallback[2] : 'default';
    }

    // find example content inside node
    const pre = node.querySelector('pre') || node.querySelector('code') || node.querySelector('.microlight');
    const text = pre ? pre.innerText.trim() : null;
    const contentType = node.querySelector('.response-col_description') ? 'application/json' : 'application/json';
    if (text) out.push({ status, contentType, text });
  }

  // if nothing found, fallback: look for any pre/code under opblock (common)
  if (out.length === 0) {
    const pres = opblock.querySelectorAll('pre, code');
    // choose those inside responses-wrapper first
    const presInResponses = opblock.querySelectorAll('.responses-wrapper pre, .responses-wrapper code');
    const chosen = presInResponses.length ? presInResponses : pres;
    Array.from(chosen).forEach((p, idx) => {
      const txt = p.innerText.trim();
      if (txt) out.push({ status: (idx === 0 ? '200' : 'example' + idx), contentType: 'application/json', text: txt });
    });
  }

  // uniq by status (keep first)
  const seen = new Set();
  const unique = [];
  for (const e of out) {
    if (!seen.has(e.status)) {
      unique.push(e);
      seen.add(e.status);
    }
  }

  return unique;
}

/* Update the right panel with structured UI */
function updateRightPanel(preferredOpblock) {
  const panelHeaderMethod = document.getElementById('code-method');
  const panelHeaderPath = document.getElementById('code-path');

  const requestSection = document.getElementById('request-section');
  const requestContentType = document.getElementById('request-content-type');
  const requestCodeArea = document.getElementById('request-code-area');
  const requestCard = document.getElementById('request-card');

  const responseSection = document.getElementById('response-section');
  const responseCodes = document.getElementById('response-codes');
  const responseContentType = document.getElementById('response-content-type');
  const responseCodeArea = document.getElementById('response-code-area');

  // reset
  requestSection.style.display = 'none';
  responseSection.style.display = 'none';
  responseCodes.innerHTML = '';
  requestCodeArea.querySelector('pre code').textContent = '';
  responseCodeArea.querySelector('pre code').textContent = '';
  responseExamples = [];
  requestExample = null;

  const opblock = preferredOpblock || lastClickedOpblock || document.querySelector('.opblock.is-open');
  if (!opblock) {
    panelHeaderMethod.className = 'method-pill default';
    panelHeaderMethod.textContent = 'OP';
    panelHeaderPath.textContent = '';
    return;
  }

  // header
  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
  panelHeaderMethod.className = 'method-pill ' + (method ? method.toLowerCase() : 'default');
  panelHeaderMethod.textContent = method || 'OP';
  panelHeaderPath.textContent = path || '';

  // extract examples
  try {
    requestExample = extractRequestExample(opblock);
  } catch (e) { requestExample = null; }
  try {
    responseExamples = extractResponseExamples(opblock);
  } catch (e) { responseExamples = []; }

  // Render request section (if present)
  if (requestExample && requestExample.text) {
    requestSection.style.display = '';
    requestContentType.textContent = requestExample.contentType || 'application/json';
    requestCodeArea.querySelector('pre code').textContent = requestExample.text || '';
    // highlight if any
    try { hljs.highlightElement(requestCodeArea.querySelector('pre code')); } catch(e){/*ignore*/ }
  } else {
    requestSection.style.display = 'none';
  }

  // Render response section
  if (responseExamples && responseExamples.length) {
    responseSection.style.display = '';
    // build badges
    responseExamples.forEach((ex, idx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'code-badge';
      btn.textContent = ex.status;
      btn.addEventListener('click', () => {
        // set active
        Array.from(responseCodes.children).forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        responseContentType.textContent = ex.contentType || 'application/json';
        responseCodeArea.querySelector('pre code').textContent = ex.text || '';
        try { hljs.highlightElement(responseCodeArea.querySelector('pre code')); } catch(e){/*ignore*/ }
      });
      // select first by default
      if (idx === 0) btn.classList.add('active');
      responseCodes.appendChild(btn);
    });

    // populate first example
    const first = responseExamples[0];
    responseContentType.textContent = first.contentType || 'application/json';
    responseCodeArea.querySelector('pre code').textContent = first.text || '';
    try { hljs.highlightElement(responseCodeArea.querySelector('pre code')); } catch(e){/*ignore*/ }
  } else {
    responseSection.style.display = 'none';
  }

  // Wire copy/expand/collapse for request
  const rCopy = document.getElementById('request-copy');
  const rExpand = document.getElementById('request-expand');
  const rCollapse = document.getElementById('request-collapse');
  if (rCopy) {
    rCopy.onclick = async () => {
      const text = requestCodeArea.querySelector('pre code')?.innerText || '';
      try {
        await navigator.clipboard.writeText(text);
        rCopy.textContent = 'Copied ✓';
        setTimeout(()=> rCopy.textContent = 'Copy', 1200);
      } catch {
        rCopy.textContent = 'Error';
        setTimeout(()=> rCopy.textContent = 'Copy', 1200);
      }
    };
  }
  if (rExpand) {
    rExpand.onclick = () => {
      requestCodeArea.querySelectorAll('pre, code').forEach(el => el.style.whiteSpace = 'pre');
    };
  }
  if (rCollapse) {
    rCollapse.onclick = () => {
      requestCodeArea.querySelectorAll('pre, code').forEach(el => el.style.whiteSpace = 'pre-wrap');
    };
  }

  // Wire copy/expand/collapse for response
  const respCopy = document.getElementById('response-copy');
  const respExpand = document.getElementById('response-expand');
  const respCollapse = document.getElementById('response-collapse');
  if (respCopy) {
    respCopy.onclick = async () => {
      const text = responseCodeArea.querySelector('pre code')?.innerText || '';
      try {
        await navigator.clipboard.writeText(text);
        respCopy.textContent = 'Copied ✓';
        setTimeout(()=> respCopy.textContent = 'Copy', 1200);
      } catch {
        respCopy.textContent = 'Error';
        setTimeout(()=> respCopy.textContent = 'Copy', 1200);
      }
    };
  }
  if (respExpand) {
    respExpand.onclick = () => {
      responseCodeArea.querySelectorAll('pre, code').forEach(el => el.style.whiteSpace = 'pre');
    };
  }
  if (respCollapse) {
    respCollapse.onclick = () => {
      responseCodeArea.querySelectorAll('pre, code').forEach(el => el.style.whiteSpace = 'pre-wrap');
    };
  }
}

/* Utility: escape html */
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* Init sequence */
(async function init() {
  try {
    await waitForSwaggerReady();
  } catch (err) {
    console.warn('Swagger UI may be slow to render:', err);
  } finally {
    try { relocateH2s(); } catch(e){/*ignore*/ }
    try { buildSidebar(); } catch(e){/*ignore*/ }
    wireSearch();
    bindGlobalOpClicks();
    observeSwagger();

    // initial populate if an op is already open
    setTimeout(() => {
      const open = document.querySelector('.opblock.is-open');
      if (open) {
        lastClickedOpblock = open;
        updateRightPanel(open);
      }
    }, 350);
  }
})();
</script>
</body>
</html>
