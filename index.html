<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV</title>

<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css" />

<style>
  :root{
    --sidebar-width: 300px;
    --right-width: 520px;
    --brand: #0b3b66;
    --accent: #0ea5e9;
    --muted: #6b7280;
    --bg: #f5f7fa;
    --panel-bg: linear-gradient(180deg,#071422,#03101b);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    color: #0b1220;
    -webkit-font-smoothing:antialiased;
  }

  /* Grid layout: sidebar / content / right panel */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    gap: 0;
    height: 100vh;
  }

  /* SIDEBAR */
  .sidebar{
    background: #fff;
    border-right:1px solid #e6e9ee;
    padding: 18px;
    display:flex;
    flex-direction:column;
    gap:14px;
    overflow:auto;
  }

  .site-brand { display:flex; gap:12px; align-items:center; }
  .brand-title{ font-weight:700; color:var(--brand); font-size:16px; margin:0; }
  .brand-sub{ font-size:12px; color:var(--muted); margin-top:2px; }

  .search input{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #e6e9ee;
    background:#fbfdff;
    font-size:13px;
  }

  .tag-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }

  .tag {
    background: #fafbfc;
    border-radius:10px;
    padding:8px;
    border:1px solid transparent;
    transition: box-shadow .12s, transform .06s, border-color .12s;
  }
  .tag:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(10,20,40,0.04); border-color: rgba(11,59,102,0.06); }

  .tag-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; cursor:pointer; }
  .tag-title { font-size:14px; color:var(--brand); font-weight:600; }
  .tag-count { background: rgba(11,59,102,0.06); color:var(--brand); padding:3px 8px; border-radius:999px; font-size:12px; }

  .tag-ops { margin-top:8px; display:none; flex-direction:column; gap:6px; }
  .tag.open .tag-ops { display:flex; }

  .op-item {
    display:flex;
    gap:8px;
    align-items:center;
    padding:6px 8px;
    border-radius:8px;
    font-size:13px;
    cursor:pointer;
    color:#0b1220;
    background:transparent;
    border:1px solid transparent;
  }
  .op-item:hover { background: rgba(11,59,102,0.04); transform: translateY(-1px); border-color: rgba(11,59,102,0.03); }

  .op-method {
    min-width:52px;
    text-align:center;
    padding:4px 8px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    color:#fff;
  }
  .op-method.get { background:#16a34a; }
  .op-method.post { background:#0ea5e9; color:#06202a; }
  .op-method.put { background:#f59e0b; color:#0b1220; }
  .op-method.delete { background:#ef4444; }

  .op-path { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .sidebar-footer { margin-top:auto; font-size:12px; color:var(--muted); }

  /* CONTENT */
  .content { background:#fff; overflow:auto; position:relative; }
  .swagger-ui { padding:20px; }

  /* RIGHT PANEL */
  .code-panel{
    background: var(--panel-bg);
    color:#fff;
    padding:18px;
    border-left:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:auto;
  }

  .endpoint-header{ display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .endpoint-info { display:flex; gap:12px; align-items:center; }
  .endpoint-title { font-weight:700; font-size:14px; color:#fff; }

  .path-text { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:rgba(255,255,255,0.92); }

  .controls { display:flex; gap:8px; align-items:center; }
  .btn { padding:7px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.04); color:#fff; cursor:pointer; font-size:13px; }
  .btn.primary { background: linear-gradient(90deg,var(--accent),#2dd4bf); color:#06202a; border:none; font-weight:700; }

  .responses-wrapper pre, .responses-wrapper code {
    background:#020617 !important;
    border-radius:8px;
    padding:12px;
    overflow:auto;
    font-size:13px;
  }

  .panel-empty { color: rgba(255,255,255,0.6); font-size:13px; padding:8px; }

  .spinner { border: 3px solid rgba(255,255,255,0.06); border-top: 3px solid rgba(255,255,255,0.18); width: 30px; height: 30px; border-radius: 50%; animation: spin .9s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* hide left opblock body only when we force-open cloning (kept for safety) */
  .opblock[data-clone-open="true"] .opblock-body { display:none !important; }

  @media (max-width:1200px){
    .layout { grid-template-columns:260px 1fr; }
    .code-panel { display:none; }
  }

  @media (max-width:880px){
    .layout { grid-template-columns:1fr; }
    .sidebar { position:fixed; left:0; top:0; bottom:0; width:76%; max-width:380px; transform:translateX(-120%); transition:transform .22s; z-index:90; box-shadow:8px 0 32px rgba(2,6,23,0.12); }
    .sidebar.open { transform:translateX(0); }
  }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="site-brand">
      <div>
        <div class="brand-title">PIX API</div>
        <div class="brand-sub">PIX API - Banco BV</div>
      </div>
    </div>

    <div class="search">
      <input id="sidebar-search" type="search" placeholder="Buscar tag, caminho ou operação..." aria-label="Buscar na documentação">
    </div>

    <ul id="sidebar-menu" class="tag-list" aria-live="polite" aria-label="Lista de tags">
      <!-- tags + submenus populated dynamically -->
    </ul>

    <div id="tag-meta" class="sidebar-footer">Open Banking · <strong>openbanking@bv.com.br</strong></div>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="content">
    <div id="swagger-ui" class="swagger-ui"></div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <div class="endpoint-header">
      <div class="endpoint-info">
        <div id="code-method" class="op-method" style="display:none"></div>
        <div class="endpoint-title" id="code-title">Abra um endpoint</div>
      </div>
      <div class="controls">
        <div id="panel-spinner" class="spinner" style="display:none"></div>
        <button id="code-copy" class="btn">Copiar</button>
        <button id="code-open" class="btn">Ir ao endpoint</button>
      </div>
    </div>

    <div id="code-view">
      <div class="panel-empty">Abra uma operação (clicando em um endpoint ou no submenu) para ver exemplos de respostas e códigos aqui.</div>
    </div>
  </aside>

</div>

<!-- scripts -->
<script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>

<script>
/*
  Correção aplicada conforme análise:
  - Remove referências diretas _targetSummary (que ficavam órfãs após re-renders)
  - Sidebar salva somente method/path
  - Na hora do clique, busca dinamicamente o .opblock-summary correspondente
  - Usa apenas um MutationObserver principal para detectar quando opblocks são abertos (is-open)
  - Reconstroi o sidebar apenas quando tags/opblocks são re-renderizados (debounced)
  - Mantém o layout e UX existentes
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";

/* Start Swagger UI */
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true
});

/* Small helpers */
const $ = (s, ctx = document) => ctx.querySelector(s);
const $$ = (s, ctx = document) => Array.from((ctx || document).querySelectorAll(s));
const debounce = (fn, t = 200) => { let id; return (...a) => { clearTimeout(id); id = setTimeout(() => fn(...a), t); }; };

/* Wait for Swagger to render summaries (robustly, using MutationObserver) */
function waitSwagger() {
  return new Promise(resolve => {
    const root = document.getElementById('swagger-ui');
    if (!root) return resolve();
    const obs = new MutationObserver(() => {
      if ($$('.opblock-summary').length) {
        obs.disconnect();
        resolve();
      }
    });
    obs.observe(root, { childList: true, subtree: true });
    // fallback immediate check
    if ($$('.opblock-summary').length) {
      obs.disconnect(); resolve();
    }
  });
}

/* Build sidebar: tags and their submenu operations.
   Save only method + path for each submenu entry.
*/
function buildSidebar() {
  const menu = $('#sidebar-menu');
  if (!menu) return;
  menu.innerHTML = '';

  $$('.opblock-tag').forEach(tagEl => {
    const title = tagEl.querySelector('h3 span')?.textContent?.trim();
    if (!title) return;

    const li = document.createElement('li');
    li.className = 'tag';

    const header = document.createElement('div');
    header.className = 'tag-header';
    header.tabIndex = 0;
    header.innerHTML = `
      <div class="tag-title">${escapeHtml(title)}</div>
      <div class="tag-count">${tagEl.querySelectorAll('.opblock').length}</div>
    `;

    const ops = document.createElement('div');
    ops.className = 'tag-ops';

    tagEl.querySelectorAll('.opblock').forEach(op => {
      const summary = op.querySelector('.opblock-summary');
      if (!summary) return;
      const method = summary.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
      const path = summary.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'op-item';
      btn.title = `${method} ${path}`;
      btn.dataset.method = method;
      btn.dataset.path = path;
      btn.innerHTML = `
        <div class="op-method ${method.toLowerCase()}">${escapeHtml(method)}</div>
        <div class="op-path">${escapeHtml(path)}</div>
      `;

      // On click, find the corresponding opblock-summary dynamically and trigger it
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        // open tag visually
        li.classList.add('open');
        header.setAttribute('aria-expanded', 'true');

        // find target summary dynamically by matching method+path
        const target = $$('.opblock-summary').find(s => {
          const m = s.querySelector('.opblock-summary-method')?.textContent?.trim();
          const p = s.querySelector('.opblock-summary-path')?.textContent?.trim();
          return m === method && p === path;
        });

        if (target) {
          try {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } catch (e) {}
          // small delay for smooth scroll then click
          setTimeout(() => {
            try {
              target.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
            } catch (err) {
              try { target.click(); } catch(e) {}
            }
          }, 120);
        }
      });

      ops.appendChild(btn);
    });

    header.addEventListener('click', () => {
      li.classList.toggle('open');
      header.setAttribute('aria-expanded', li.classList.contains('open') ? 'true' : 'false');
    });
    header.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); } });

    li.appendChild(header);
    li.appendChild(ops);
    menu.appendChild(li);
  });
}

/* Update right panel when an opblock is opened */
function updateRightPanel(opblock) {
  const panel = $('#code-view');
  if (!panel) return;
  panel.innerHTML = '';

  if (!opblock) return;

  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

  const titleEl = document.getElementById('code-title');
  titleEl.textContent = `${method} ${path}`;

  const codeMethodEl = document.getElementById('code-method');
  if (method) {
    codeMethodEl.textContent = method;
    codeMethodEl.className = `op-method ${method.toLowerCase()}`;
    codeMethodEl.style.display = '';
  } else {
    codeMethodEl.style.display = 'none';
  }

  const responses = opblock.querySelector('.responses-wrapper');
  if (responses) {
    panel.appendChild(responses.cloneNode(true));
  } else {
    // try to present inline pre blocks if any
    const pres = opblock.querySelectorAll('pre');
    if (pres && pres.length) {
      pres.forEach(p => panel.appendChild(p.cloneNode(true)));
      return;
    }
    panel.innerHTML = '<div class="panel-empty">Nenhuma resposta encontrada.</div>';
  }
}

/* Observe opblock opens and tag changes (single observer)
   - When opblock receives class "is-open", update right panel
   - When tags/opblocks are added, rebuild sidebar (debounced)
*/
function attachObserver() {
  const root = document.getElementById('swagger-ui');
  if (!root) return;

  const observer = new MutationObserver(mutations => {
    let tagsChanged = false;
    for (const m of mutations) {
      if (m.type === 'attributes' && m.target.classList && m.target.classList.contains('opblock')) {
        // opblock opened
        const el = m.target;
        if (el.classList.contains('is-open')) {
          // small delay to allow Swagger to populate responses
          setTimeout(() => updateRightPanel(el), 120);
        }
      }
      if (m.type === 'childList' && (m.addedNodes.length || m.removedNodes.length)) {
        // additions/removals within swagger UI might indicate tags/opblocks changed
        tagsChanged = true;
      }
    }
    if (tagsChanged) {
      debouncedRebuild();
    }
  });

  observer.observe(root, { subtree: true, childList: true, attributes: true, attributeFilter: ['class'] });
}

/* Debounced rebuild to avoid loops */
const debouncedRebuild = debounce(() => {
  buildSidebar();
}, 300);

/* Utility: escape HTML to prevent injection into sidebar */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* Init: wait for swagger, then build sidebar and attach observer */
(async function init() {
  try {
    await waitSwagger();
    buildSidebar();
    attachObserver();

    // wire up a small search to filter tags/ops (keeps previous behavior)
    const input = document.getElementById('sidebar-search');
    if (input) {
      input.addEventListener('input', debounce(() => {
        const q = input.value.trim().toLowerCase();
        document.querySelectorAll('#sidebar-menu .tag').forEach(tag => {
          const tagTitle = tag.querySelector('.tag-title')?.textContent?.toLowerCase() || '';
          let anyOpMatch = false;
          tag.querySelectorAll('.op-item').forEach(op => {
            const title = (op.title || '').toLowerCase();
            const match = !q || title.includes(q) || tagTitle.includes(q);
            op.style.display = match ? '' : 'none';
            if (match) anyOpMatch = true;
          });
          tag.style.display = (anyOpMatch || (!q || tagTitle.includes(q))) ? '' : 'none';
          if (anyOpMatch) tag.classList.add('open'); else tag.classList.remove('open');
        });
      }, 200));
    }

    // if an opblock is already open on load, update panel
    setTimeout(() => {
      const open = document.querySelector('.opblock.is-open');
      if (open) updateRightPanel(open);
    }, 250);

  } catch (err) {
    console.warn('Erro inicializando a UI aprimorada:', err);
  }
})();
</script>

</body>
</html>
