<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV</title>

<!-- Swagger UI v5 CSS -->
<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5.0.0/swagger-ui.css" />

<style>
  :root{
    --sidebar-width: 280px;
    --right-width: 520px;
    --brand: #0b3b66;
    --accent: #0ea5e9;
    --muted: #6b7280;
    --bg: #f5f7fa;
    --panel-bg: linear-gradient(180deg,#071422,#03101b);
    --content-max: 880px;
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    color: #0b1220;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Main grid: left sidebar / center content / right panel */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    gap: 0;
    height: 100vh;
    overflow: hidden;
  }

  /* ===== LEFT SIDEBAR ===== */
  .sidebar {
    background: #ffffff;
    border-right: 1px solid #e6e9ee;
    padding: 22px 16px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    overflow-y: auto;
  }

  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }

  .brand svg { width:56px; height:56px; flex:0 0 56px; }
  .brand .brand-text { display:flex; flex-direction:column; }
  .brand .brand-title { font-weight:700; color:var(--brand); font-size:18px; margin:0; line-height:1; }
  .brand .brand-sub { font-size:12px; color:var(--muted); margin-top:3px; }

  .sidebar .search {
    margin-top:6px;
  }

  .sidebar input[type="search"] {
    width:100%;
    padding:9px 12px;
    border-radius:8px;
    border:1px solid #e6e9ee;
    background:#fbfdff;
    font-size:13px;
  }

  .nav {
    margin-top:8px;
  }

  .nav ul {
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .tag {
    background: #fafbfc;
    border-radius:10px;
    padding:8px;
    border:1px solid transparent;
    transition: 120ms ease;
  }
  .tag:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(10,20,40,0.04); border-color: rgba(11,59,102,0.06); }

  .tag-header {
    display:flex;
    justify-content:space-between;
    gap:8px;
    align-items:center;
    cursor:pointer;
    padding:4px 6px;
  }
  .tag-title { color:var(--brand); font-weight:600; font-size:14px; }
  .tag-count { background: rgba(11,59,102,0.06); color:var(--brand); padding:3px 8px; border-radius:999px; font-size:12px; }

  .tag-ops {
    margin-top:8px;
    display:none;
    flex-direction:column;
    gap:6px;
  }
  .tag.open .tag-ops { display:flex; }

  .op-item {
    display:flex;
    gap:8px;
    align-items:center;
    padding:6px 8px;
    border-radius:8px;
    font-size:13px;
    cursor:pointer;
    color:#0b1220;
    background:transparent;
    border:1px solid transparent;
    text-align:left;
  }
  .op-item:hover { background: rgba(11,59,102,0.04); transform: translateY(-1px); border-color: rgba(11,59,102,0.03); }

  .op-method {
    min-width:54px;
    text-align:center;
    padding:4px 8px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    color:#fff;
  }
  .op-method.get { background:#16a34a; }
  .op-method.post { background:#0ea5e9; color:#06202a; }
  .op-method.put { background:#f59e0b; color:#0b1220; }
  .op-method.delete { background:#ef4444; }

  .op-path {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
    font-size:12px;
    color:var(--muted);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  /* minimize default swagger left content spacing inside sidebar for v5 */
  .sidebar .credit { display:none; }

  /* ===== CENTER CONTENT ===== */
  .content {
    background: #ffffff;
    overflow-y: auto;
    padding: 28px 40px;
  }

  .content .doc-wrapper {
    max-width: var(--content-max);
    margin: 0 auto;
    padding-right: 24px;
  }

  .doc-title {
    font-size:20px;
    font-weight:700;
    color:#13233b;
    margin-bottom:8px;
  }

  .doc-intro {
    color: #44515a;
    line-height:1.6;
    margin-bottom:20px;
    font-size:14px;
  }

  /* make embedded swagger UI area take full width inside center column */
  #swagger-ui { margin-top:18px; }

  /* ===== RIGHT PANEL ===== */
  .code-panel {
    background: var(--panel-bg);
    color:#fff;
    padding:18px 18px;
    border-left:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:auto;
  }

  .code-panel .panel-top {
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }
  .panel-title { font-weight:700; color:#dfe9ee; font-size:14px; }

  .panel-controls { display:flex; gap:8px; align-items:center; }

  .panel-select {
    background: rgba(255,255,255,0.03);
    color: #e6eef0;
    border: 1px solid rgba(255,255,255,0.04);
    padding:6px 10px;
    border-radius:8px;
    font-size:13px;
  }

  .responses-wrapper {
    margin-top:8px;
  }

  .responses-wrapper pre {
    background: #020617 !important;
    border-radius:8px;
    padding:14px;
    overflow:auto;
  }

  .panel-empty { color: rgba(255,255,255,0.6); font-size:13px; padding:8px; }

  /* Responsive behavior */
  @media (max-width: 1200px) {
    .layout {
      grid-template-columns: 260px 1fr;
    }
    .code-panel {
      display: none;
    }
  }

  @media (max-width: 880px) {
    .layout {
      grid-template-columns: 1fr;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 76%;
      max-width: 380px;
      transform: translateX(-120%);
      transition: transform .22s ease;
      z-index: 100;
      box-shadow: 8px 0 32px rgba(2,6,23,0.12);
    }
    .sidebar.open { transform: translateX(0); }
    .code-panel { position: fixed; right: 8px; top: 72px; bottom: 8px; width: calc(100% - 16px); max-width: 720px; z-index: 100; border-radius:8px; }
  }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand" aria-hidden="false">
      <!-- simple BV-style SVG mark (placeholder, you can replace with official asset) -->
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Banco BV">
        <rect width="100" height="100" rx="8" fill="#f3f7fb"/>
        <g transform="translate(12,18)">
          <path d="M8 50 L32 20 L56 50 L32 80 Z" fill="#2b6fb0"></path>
          <path d="M64 20 L86 20 L86 68 L64 68 Z" fill="#2dd4bf"></path>
        </g>
      </svg>
      <div class="brand-text">
        <div class="brand-title">PIX API</div>
        <div class="brand-sub">Banco BV</div>
      </div>
    </div>

    <div class="search">
      <input id="sidebar-search" type="search" placeholder="Search..." aria-label="Buscar">
    </div>

    <nav class="nav" aria-label="Navegação da documentação">
      <ul id="sidebar-menu" class="tag-list" aria-live="polite">
        <!-- dynamically populated -->
      </ul>
    </nav>
  </aside>

  <!-- CENTER CONTENT -->
  <main class="content" id="content">
    <div class="doc-wrapper">
      <h2 class="doc-title">Documentação PIX - Banco BV</h2>
      <p class="doc-intro">
        Navegue pela API usando o menu à esquerda. Ao abrir um endpoint, exemplos de resposta aparecerão no painel à direita.
      </p>

      <!-- Swagger UI area (left of right panel) -->
      <div id="swagger-ui"></div>
    </div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <div class="panel-top">
      <div class="panel-title" id="code-title">Abra um endpoint</div>
      <div class="panel-controls">
        <select id="panel-status" class="panel-select" aria-label="Status">
          <option value="">response</option>
        </select>
        <button id="code-copy" class="panel-select">Copiar</button>
      </div>
    </div>

    <div id="code-view">
      <div class="panel-empty">Abra uma operação (clicando em um endpoint) para ver exemplos de respostas e códigos aqui.</div>
    </div>
  </aside>

</div>

<!-- scripts: Swagger UI v5 bundle -->
<script src="https://unpkg.com/swagger-ui-dist@5.0.0/swagger-ui-bundle.js"></script>

<script>
/*
  Integration logic:
  - Uses Swagger UI v5
  - Builds a left sidebar with tags and nested submenu operations (method + path).
  - Clicking a submenu finds the matching .opblock-summary dynamically and triggers a click (so Swagger renders).
  - A single MutationObserver watches swagger root:
      - when an .opblock receives the is-open class -> clone its responses into the right panel
      - when DOM childList changes (tags/opblocks added/removed) -> rebuild sidebar (debounced)
  - Lazy behavior for status list: reads available status keys from cloned responses (if present) and populates the select.
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";

/* Initialize Swagger UI v5 */
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true
});

/* Helpers */
const $ = (sel, ctx = document) => ctx.querySelector(sel);
const $$ = (sel, ctx = document) => Array.from((ctx || document).querySelectorAll(sel));
const debounce = (fn, t = 200) => { let id; return (...a) => { clearTimeout(id); id = setTimeout(() => fn(...a), t); }; };

/* Wait for basic rendering (opblock-summary elements) */
function waitSwaggerReady(timeout = 12000) {
  return new Promise((resolve, reject) => {
    const root = document.getElementById('swagger-ui');
    if (!root) return reject(new Error('swagger-ui missing'));
    const start = Date.now();
    const obs = new MutationObserver(() => {
      if ($$('.opblock-summary').length) {
        obs.disconnect();
        resolve();
      } else if (Date.now() - start > timeout) {
        obs.disconnect();
        reject(new Error('Timeout waiting for Swagger UI'));
      }
    });
    obs.observe(root, { childList: true, subtree: true });
    if ($$('.opblock-summary').length) { obs.disconnect(); resolve(); }
  });
}

/* Build sidebar (tags + submenu ops).
   Save only method and path in dataset for each button; resolution happens at click time.
*/
function buildSidebar() {
  const menu = $('#sidebar-menu');
  if (!menu) return;
  menu.innerHTML = '';

  $$('.opblock-tag').forEach(tagEl => {
    const title = tagEl.querySelector('h3 span')?.textContent?.trim();
    if (!title) return;

    const li = document.createElement('li');
    li.className = 'tag';

    const header = document.createElement('div');
    header.className = 'tag-header';
    header.tabIndex = 0;
    header.innerHTML = `
      <div class="tag-title">${escapeHtml(title)}</div>
      <div class="tag-count">${tagEl.querySelectorAll('.opblock').length}</div>
    `;

    const ops = document.createElement('div');
    ops.className = 'tag-ops';

    tagEl.querySelectorAll('.opblock').forEach(op => {
      const summary = op.querySelector('.opblock-summary');
      if (!summary) return;
      const method = summary.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
      const path = summary.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'op-item';
      btn.title = `${method} ${path}`;
      btn.dataset.method = method;
      btn.dataset.path = path;
      btn.innerHTML = `
        <div class="op-method ${method.toLowerCase()}">${escapeHtml(method)}</div>
        <div class="op-path">${escapeHtml(path)}</div>
      `;

      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        li.classList.add('open');
        header.setAttribute('aria-expanded', 'true');

        // Find matching summary dynamically and trigger click
        const target = $$('.opblock-summary').find(s => {
          const m = s.querySelector('.opblock-summary-method')?.textContent?.trim();
          const p = s.querySelector('.opblock-summary-path')?.textContent?.trim();
          return m === method && p === path;
        });

        if (target) {
          try { target.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(e) {}
          setTimeout(() => {
            try { target.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window })); }
            catch { try { target.click(); } catch(e) {} }
          }, 120);
        }
      });

      ops.appendChild(btn);
    });

    header.addEventListener('click', () => {
      const open = li.classList.toggle('open');
      header.setAttribute('aria-expanded', open ? 'true' : 'false');
    });
    header.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); } });

    li.appendChild(header);
    li.appendChild(ops);
    menu.appendChild(li);
  });
}

/* Clone responses from a given opblock into right panel */
function updateRightPanel(opblock) {
  const panel = $('#code-view');
  if (!panel) return;
  panel.innerHTML = '';

  if (!opblock) {
    panel.innerHTML = '<div class="panel-empty">Abra uma operação para ver exemplos de respostas e códigos aqui.</div>';
    $('#code-title').textContent = 'Abra um endpoint';
    return;
  }

  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
  $('#code-title').textContent = `${method} ${path}`;

  const codeMethodEl = $('#code-method');
  if (codeMethodEl) {
    if (method) { codeMethodEl.textContent = method; codeMethodEl.className = `op-method ${method.toLowerCase()}`; codeMethodEl.style.display = ''; }
    else { codeMethodEl.style.display = 'none'; }
  }

  const responses = opblock.querySelector('.responses-wrapper');
  if (responses) {
    const clone = responses.cloneNode(true);
    // remove interactive buttons that don't make sense in the right panel
    clone.querySelectorAll('.try-out, .execute, .btn, .model, .responses-request, .parameters').forEach(n => n.remove());
    panel.appendChild(clone);
    // populate status select if there are status buttons inside the cloned area
    populateStatusSelect(clone);
    // highlight code blocks lazily
    lazyHighlight(panel);
    return;
  }

  // fallback to inline <pre> blocks
  const pres = opblock.querySelectorAll('pre');
  if (pres && pres.length) {
    pres.forEach(p => panel.appendChild(p.cloneNode(true)));
    lazyHighlight(panel);
    return;
  }

  panel.innerHTML = '<div class="panel-empty">Nenhuma resposta encontrada.</div>';
}

/* Populate status select based on the cloned responses (if present) */
function populateStatusSelect(clonedResponses) {
  const select = $('#panel-status');
  if (!select) return;
  select.innerHTML = ''; // reset
  // attempt to find status buttons rendered by Swagger: they often have class like 'responses-inner' with buttons or .response
  const statuses = Array.from(new Set(Array.from(clonedResponses.querySelectorAll('.response, .responses-table, .response-col_status') || [])
    .map(n => {
      // try common patterns
      const statusFromButton = n.querySelector('.response-col_status')?.textContent?.trim();
      if (statusFromButton) return statusFromButton;
      const header = n.querySelector('.response')?.textContent?.trim();
      if (header) return header;
      return n.getAttribute('data-status') || n.getAttribute('data-code') || n.querySelector('h4')?.textContent?.trim();
    }).filter(Boolean)));

  // If status detection fails, try to read explicit keys from examples (e.g., 200/400)
  if (!statuses.length) {
    const possible = ['200','201','204','400','401','403','404','500'];
    possible.forEach(s => {
      // try to detect presence of an element containing that code
      if (clonedResponses.innerText.includes(s)) statuses.push(s);
    });
  }

  if (statuses.length === 0) {
    select.style.display = 'none';
    return;
  }

  select.style.display = '';
  // Add an empty option first
  const emptyOpt = document.createElement('option');
  emptyOpt.value = '';
  emptyOpt.textContent = 'response';
  select.appendChild(emptyOpt);

  statuses.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    select.appendChild(opt);
  });
}

/* Lazy highlight using highlight.js only when needed */
let hljsLoaded = false;
let hljsLoading = false;
function lazyHighlight(container) {
  // find code blocks
  const blocks = container.querySelectorAll('pre code, pre');
  if (!blocks.length) return;

  if (hljsLoaded) {
    container.querySelectorAll('pre code').forEach(b => { try { window.hljs.highlightElement(b); } catch(e){} });
    return;
  }

  if (hljsLoading) return;
  hljsLoading = true;

  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js';
  script.onload = () => {
    hljsLoaded = true;
    container.querySelectorAll('pre code').forEach(b => { try { window.hljs.highlightElement(b); } catch(e){} });
  };
  script.onerror = () => { hljsLoading = false; };
  document.head.appendChild(script);

  const link = document.createElement('link');
  link.rel = 'stylesheet';
  link.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css';
  document.head.appendChild(link);
}

/* Single observer that watches for opblock opens and tag/op changes.
   - When an opblock gets is-open, we clone responses into the right panel.
   - When childList changes (tags/opblocks added/removed), rebuild sidebar (debounced).
*/
function attachMainObserver() {
  const root = document.getElementById('swagger-ui');
  if (!root) return;

  const observer = new MutationObserver(mutations => {
    let needsRebuild = false;
    for (const m of mutations) {
      if (m.type === 'attributes' && m.target.classList && m.target.classList.contains('opblock')) {
        const el = m.target;
        if (el.classList.contains('is-open')) {
          // small delay allowing Swagger to populate responses
          setTimeout(() => updateRightPanel(el), 120);
        }
      }
      if (m.type === 'childList' && (m.addedNodes.length || m.removedNodes.length)) {
        needsRebuild = true;
      }
    }
    if (needsRebuild) debouncedBuild();
  });

  observer.observe(root, { subtree: true, childList: true, attributes: true, attributeFilter: ['class'] });
}

const debouncedBuild = debounce(() => { buildSidebar(); }, 300);

/* Basic search/filter for sidebar */
function initSidebarSearch() {
  const input = $('#sidebar-search');
  if (!input) return;
  input.addEventListener('input', debounce(() => {
    const q = input.value.trim().toLowerCase();
    document.querySelectorAll('#sidebar-menu .tag').forEach(tag => {
      const tagTitle = tag.querySelector('.tag-title')?.textContent?.toLowerCase() || '';
      let anyOpMatch = false;
      tag.querySelectorAll('.op-item').forEach(op => {
        const title = (op.title || '').toLowerCase();
        const match = !q || title.includes(q) || tagTitle.includes(q);
        op.style.display = match ? '' : 'none';
        if (match) anyOpMatch = true;
      });
      tag.style.display = (anyOpMatch || (!q || tagTitle.includes(q))) ? '' : 'none';
      if (anyOpMatch) tag.classList.add('open'); else tag.classList.remove('open');
    });
  }, 180));
}

/* Utility to escape HTML to avoid injecting markup into sidebar */
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* Initialize wiring after Swagger has rendered initial DOM */
(async function init() {
  try {
    await waitSwaggerReady();
    buildSidebar();
    attachMainObserver();
    initSidebarSearch();

    // in case some opblock is already open on load
    setTimeout(() => {
      const open = document.querySelector('.opblock.is-open');
      if (open) updateRightPanel(open);
    }, 300);

    // rebuild sidebar if swagger re-renders later (keeps up-to-date)
    const uiRoot = document.getElementById('swagger-ui');
    if (uiRoot) {
      const mo = new MutationObserver(debouncedBuild);
      mo.observe(uiRoot, { childList: true, subtree: true });
    }
  } catch (err) {
    console.warn('Erro inicializando UI aprimorada:', err);
  }
})();

/* Copy button */
document.getElementById('code-copy').addEventListener('click', async () => {
  const panel = document.getElementById('code-view');
  if (!panel) return;
  let text = '';
  const codes = panel.querySelectorAll('pre code');
  if (codes.length) text = Array.from(codes).map(c => c.innerText).join('\n\n---\n\n');
  else text = panel.innerText || '';
  try {
    await navigator.clipboard.writeText(text);
    const btn = document.getElementById('code-copy');
    btn.textContent = 'Copiado ✓';
    setTimeout(() => btn.textContent = 'Copiar', 1200);
  } catch {
    const btn = document.getElementById('code-copy');
    btn.textContent = 'Erro';
    setTimeout(() => btn.textContent = 'Copiar', 1200);
  }
});

/* "Ir ao endpoint" button behavior: scroll to matching opblock and flash it */
document.getElementById('code-open').addEventListener('click', () => {
  const title = document.getElementById('code-title').textContent || '';
  if (!title) return;
  const summaries = $$('.opblock-summary');
  for (const s of summaries) {
    const method = s.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
    const path = s.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
    if ((method + ' ' + path).trim() === title.trim()) {
      const op = s.closest('.opblock');
      if (op) {
        op.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const prev = op.style.boxShadow;
        op.style.boxShadow = '0 10px 36px rgba(14,165,233,0.12)';
        setTimeout(() => op.style.boxShadow = prev || '', 900);
      }
      break;
    }
  }
});
</script>
</body>
</html>
