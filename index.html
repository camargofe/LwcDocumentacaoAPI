<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV</title>

<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css" />
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" />

<style>
  :root{
    --sidebar-width: 300px;
    --right-width: 520px;
    --brand: #002f6c;
    --muted: #6b7280;
    --bg: #f5f7fa;
  }

  html, body {
    margin: 0;
    height: 100%;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: var(--bg);
    color: #0b1220;
  }

  /* ===== LAYOUT ===== */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    height: 100vh;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    background: #fff;
    border-right: 1px solid #e6e9ee;
    padding: 16px;
    overflow-y: auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .brand {
    display:flex;
    gap:10px;
    align-items:center;
  }

  .brand-logo {
    height: 40px;
    width: auto;
    display:block;
  }

  .sidebar h3 {
    font-size: 15px;
    color: var(--brand);
    margin: 0;
  }

  .sidebar .search {
    display:flex;
  }

  .sidebar input[type="search"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #e6e9ee;
    background: #fbfdff;
    font-size: 13px;
  }

  .tag-list {
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .tag-item {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
    transition: background .12s, transform .06s;
  }

  .tag-item:hover { background: rgba(0,47,108,0.06); transform: translateY(-1px); }
  .tag-item.active { background: linear-gradient(90deg,#e9f1ff,#fbfdff); border:1px solid rgba(0,47,108,0.06); }

  .tag-count {
    background: rgba(0,47,108,0.08);
    color: var(--brand);
    padding: 3px 8px;
    border-radius:999px;
    font-size:12px;
  }

  .sidebar .meta {
    color: var(--muted);
    font-size: 12px;
  }

  /* ===== CONTENT ===== */
  .content {
    background: #ffffff;
    overflow-y: auto;
  }

  .swagger-ui {
    padding: 18px;
  }

  /* ===== RIGHT PANEL ===== */
  .code-panel {
    background: #071022;
    border-left: 1px solid rgba(255,255,255,0.03);
    padding: 16px;
    color: #fff;
    overflow-y: auto;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .endpoint-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }

  .endpoint-title {
    display:flex;
    align-items:center;
    gap:8px;
  }

  .method-pill {
    padding:6px 10px;
    border-radius:8px;
    font-weight:700;
    font-size:12px;
    color:#fff;
  }
  .method-pill.get { background:#16a34a; }
  .method-pill.post { background:#0ea5e9; }
  .method-pill.put { background:#f59e0b; color:#0b1220; }
  .method-pill.delete { background:#ef4444; }
  .method-pill.default { background: rgba(255,255,255,0.06); }

  .path-text { color: rgba(255,255,255,0.95); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:13px; }

  .controls { display:flex; gap:8px; align-items:center; }

  .btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.04);
    color: #fff;
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    font-size:13px;
  }
  .btn.primary { background: linear-gradient(90deg,#0ea5e9,#2dd4bf); color:#06202a; font-weight:700; border:none; }

  .responses-wrapper pre {
    background: #020617 !important;
    border-radius: 6px;
    padding:12px;
    overflow:auto;
  }

  .panel-empty { color: rgba(255,255,255,0.6); font-size:13px; padding:8px; }

  /* Hide left opblock body only when we force-open for cloning (not used in this version but kept for safety) */
  .opblock[data-clone-open="true"] .opblock-body {
    display:none !important;
  }

  /* Responsive: collapse right panel on narrow screens */
  @media (max-width: 1200px) {
    .layout { grid-template-columns: 260px 1fr; }
    .code-panel { display: none; }
  }

  @media (max-width: 880px) {
    .layout { grid-template-columns: 1fr; }
    .sidebar { position: fixed; left:0; top:0; bottom:0; width:76%; max-width:380px; transform: translateX(-120%); transition:transform .22s; z-index:90; box-shadow:8px 0 32px rgba(2,6,23,0.12); }
    .sidebar.open { transform: translateX(0); }
  }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <img src="https://developers-sandbox.bvopen.com.br/sites/default/files/apidoc_specs/API-PIX-V1/assets/images/logo.png" alt="Banco BV" class="brand-logo" />
      <div>
        <h3>Documentação</h3>
        <div class="meta">PIX API - Banco BV</div>
      </div>
    </div>

    <div class="search">
      <input id="sidebar-search" type="search" placeholder="Buscar tag, caminho ou operação..." aria-label="Buscar">
    </div>

    <ul id="sidebar-menu" class="tag-list" aria-live="polite" aria-label="Lista de tags"></ul>

    <!-- tag-meta removed per request -->
  </aside>

  <!-- CONTENT -->
  <main class="content" id="content">
    <div id="swagger-ui" class="swagger-ui"></div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <div class="endpoint-header">
      <div class="endpoint-title">
        <span id="code-method" class="method-pill default">OP</span>
        <div id="code-path" class="path-text">/caminho/exemplo</div>
      </div>
      <div class="controls">
        <button id="code-copy" class="btn">Copiar</button>
        <button id="code-open" class="btn">Ir ao endpoint</button>
      </div>
    </div>

    <div id="code-view"><div class="panel-empty">Abra uma operação (clicando em um endpoint) para ver exemplos de respostas e códigos aqui.</div></div>
  </aside>

</div>

<!-- scripts -->
<script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<script>
/*
  Strategy:
  - Keep the improved sidebar and right fixed panel layout (3-column grid).
  - DO NOT intercept or block Swagger's native click behavior.
  - Listen for user clicks (event delegation) on .opblock-summary to record the clicked opblock.
  - Also observe DOM attribute changes (class) so that when an opblock gets .is-open we capture it.
  - When an opblock is open (or was just clicked), clone its .responses-wrapper (or <pre> examples) into the right panel.
  - This approach relies on Swagger performing its normal render of the response examples when an opblock is opened.
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";

let lastClickedOpblock = null;

// Initialize Swagger UI
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true,
  presets: [SwaggerUIBundle.presets.apis]
});

// small helpers
const $qs = (s, scope = document) => scope.querySelector(s);
const $qsa = (s, scope = document) => Array.from(scope.querySelectorAll(s));

function waitForSwaggerReady(timeout = 10000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function check() {
      if ($qsa('.opblock-tag').length > 0) return resolve();
      if (Date.now() - start > timeout) return reject(new Error('Swagger UI did not render in time'));
      requestAnimationFrame(check);
    })();
  });
}

/* Build improved sidebar from opblock tags */
function buildSidebar() {
  const menu = document.getElementById('sidebar-menu');
  menu.innerHTML = '';

  const tags = $qsa('.opblock-tag');
  tags.forEach(tagEl => {
    const titleSpan = tagEl.querySelector('h3 span');
    if (!titleSpan) return;
    const titleText = titleSpan.textContent.trim();

    const operations = tagEl.querySelectorAll('.opblock-summary');
    const count = operations.length;

    const li = document.createElement('li');
    li.className = 'tag-item';
    li.tabIndex = 0;
    li.dataset.tag = titleText;
    li.innerHTML = `<div><strong>${escapeHtml(titleText)}</strong></div><div class="tag-count">${count}</div>`;

    li.addEventListener('click', () => {
      tagEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      setActiveTag(titleText);
    });

    li.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); li.click(); }
    });

    menu.appendChild(li);
  });
}

/* Set active tag in sidebar (no meta text updates per request) */
function setActiveTag(name) {
  const menu = document.getElementById('sidebar-menu');
  Array.from(menu.children).forEach(li => li.classList.toggle('active', li.dataset.tag === name));
}

 /* Bind clicks on opblock summaries (delegation) to capture last clicked opblock
   We DO NOT prevent default: let Swagger open the block so examples render. */
function bindEndpointClicks() {
  const container = document.getElementById('swagger-ui');
  if (!container) return;

  container.addEventListener('click', (e) => {
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;

    // remember last clicked opblock so updateRightPanel knows which to prefer
    lastClickedOpblock = opblock;

    // small delay to allow Swagger to toggle .is-open and render the responses
    setTimeout(() => updateRightPanel(opblock), 220);
  });

  // keyboard activation
  container.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;

    lastClickedOpblock = opblock;
    setTimeout(() => updateRightPanel(opblock), 220);
  });
}

/* Observe class changes so we catch programmatic opens or other ways the opblock is opened */
function observeOpblockOpenEvents() {
  const uiRoot = document.querySelector('.swagger-ui');
  if (!uiRoot) return;

  const mo = new MutationObserver(mutations => {
    for (const m of mutations) {
      if (m.type === 'attributes' && m.attributeName === 'class') {
        const target = m.target;
        if (target.classList && target.classList.contains('opblock') && target.classList.contains('is-open')) {
          // opblock gained is-open; prefer the recently clicked opblock, otherwise use this one
          const preferred = lastClickedOpblock || target;
          setTimeout(() => updateRightPanel(preferred), 80);
        }
      }

      if (m.addedNodes && m.addedNodes.length) {
        // new opblocks rendered -> rebuild sidebar (debounced)
        clearTimeout(window._rebuild_sidebar);
        window._rebuild_sidebar = setTimeout(() => {
          buildSidebar();
          wireActiveTagHighlighting();
        }, 180);
      }
    }
  });

  mo.observe(uiRoot, { subtree: true, childList: true, attributes: true, attributeFilter: ['class'] });
}

/* Find the responses/examples area inside an opblock reliably */
function findResponsesWrapper(opblockEl) {
  if (!opblockEl) return null;

  // Common directly available wrapper
  let node = opblockEl.querySelector('.responses-wrapper');
  if (node) return node;

  // Some swagger versions place responses inside sections
  node = opblockEl.querySelector('.opblock-body .responses-wrapper');
  if (node) return node;

  node = opblockEl.querySelector('.opblock-section .responses-wrapper');
  if (node) return node;

  // Examples can be under .response or inside tables; try to find <pre> blocks
  const pre = opblockEl.querySelector('pre');
  if (pre) {
    const wrapper = document.createElement('div');
    wrapper.className = 'responses-wrapper';
    wrapper.appendChild(pre.cloneNode(true));
    return wrapper;
  }

  // No responses found
  return null;
}

/* Update right panel with cloned responses from the given opblock (or fallback logic) */
function updateRightPanel(preferredOpblock) {
  const panel = document.getElementById('code-view');
  panel.innerHTML = '';

  // Determine target opblock: prefer provided, then lastClickedOpblock, then first open
  let opblock = preferredOpblock || lastClickedOpblock || document.querySelector('.opblock.is-open');
  if (!opblock) {
    // nothing to show
    panel.innerHTML = '<div class="panel-empty">Abra uma operação para ver exemplos de respostas e códigos aqui.</div>';
    return;
  }

  // If the opblock is not open yet (no .is-open) we still try, but prefer that the user click so Swagger renders content.
  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

  // Header
  document.getElementById('code-method').className = 'method-pill ' + (method ? method.toLowerCase() : 'default');
  document.getElementById('code-method').textContent = method || 'OP';
  document.getElementById('code-path').textContent = path || '';

  // Try to find responses
  let responses = findResponsesWrapper(opblock);

  // If not found, but the opblock is not open, give Swagger a small moment (sometimes rendering is slightly delayed)
  if (!responses && !opblock.classList.contains('is-open')) {
    // Wait a short bit and retry (non-blocking)
    setTimeout(() => updateRightPanel(opblock), 200);
    // meanwhile show spinner-like message
    panel.innerHTML = '<div class="panel-empty">Carregando exemplos...</div>';
    return;
  }

  if (!responses) {
    panel.innerHTML = '<div class="panel-empty">Nenhuma resposta de exemplo encontrada para este endpoint.</div>';
    return;
  }

  // Clone responses for the right panel
  const clone = responses.cloneNode(true);

  // Remove interactive elements not useful in the right panel
  clone.querySelectorAll('.try-out, .execute, .btn, .model, .responses-request, .parameters').forEach(n => n.remove());

  // Normalize any pre/code blocks for highlight.js
  clone.querySelectorAll('pre, code').forEach(el => {
    el.style.whiteSpace = 'pre';
    el.style.wordBreak = 'break-word';
    el.classList.add('hljs');
  });

  // Append header + cloned responses
  panel.appendChild(clone);

  // Highlight code blocks inside panel
  panel.querySelectorAll('pre code').forEach(block => {
    try { hljs.highlightElement(block); } catch(e) { /* ignore */ }
  });

  // Setup copy button to copy concatenated code blocks or panel text
  const copyBtn = document.getElementById('code-copy');
  copyBtn.onclick = async () => {
    let text = '';
    const codes = panel.querySelectorAll('pre code');
    if (codes.length) {
      text = Array.from(codes).map(c => c.innerText).join('\n\n---\n\n');
    } else {
      text = panel.innerText;
    }
    try {
      await navigator.clipboard.writeText(text);
      copyBtn.textContent = 'Copiado ✓';
      setTimeout(() => copyBtn.textContent = 'Copiar', 1200);
    } catch {
      copyBtn.textContent = 'Erro';
      setTimeout(() => copyBtn.textContent = 'Copiar', 1200);
    }
  };

  // When "Ir ao endpoint" is clicked, scroll to the opblock and briefly highlight it
  const openBtn = document.getElementById('code-open');
  openBtn.onclick = () => {
    opblock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const prev = opblock.style.boxShadow;
    opblock.style.boxShadow = '0 10px 36px rgba(14,165,233,0.12)';
    setTimeout(() => opblock.style.boxShadow = prev || '', 900);
  };
}

/* Basic tag highlighting based on viewport (IntersectionObserver) */
function wireActiveTagHighlighting() {
  const tagEls = $qsa('.opblock-tag');
  if (!tagEls.length) return;
  const obsRoot = document.querySelector('.content') || null;
  const options = { root: obsRoot, rootMargin: '0px 0px -60% 0px', threshold: [0.1, 0.4] };
  const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const name = entry.target.querySelector('h3 span')?.textContent?.trim();
        if (name) setActiveTag(name);
      }
    });
  }, options);
  tagEls.forEach(t => observer.observe(t));
}

/* Utility: escape text for safe insertion */
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* Initialize everything after Swagger UI renders */
(async function init() {
  try {
    await waitForSwaggerReady();

    // Build sidebar and wire interactions
    buildSidebar();
    wireActiveTagHighlighting();
    bindEndpointClicks();
    observeOpblockOpenEvents();

    // If an opblock is already open on load, populate right panel for it
    setTimeout(() => {
      const open = document.querySelector('.opblock.is-open');
      if (open) {
        lastClickedOpblock = open;
        updateRightPanel(open);
      }
    }, 300);
  } catch (err) {
    console.warn('Erro inicializando UI melhorada:', err);
  }
})();
</script>
</body>
</html>
