<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV</title>

<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css" />
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" />

<style>
  :root{
    --sidebar-width: 300px;
    --right-width: 520px;
    --brand: #1b6bb3;
    --muted: #6b7280;
    --bg: #f7f7f7;
    --right-bg: #263238;
    --right-card: #0e1416;
    --accent: #2dd4bf;
    --fixed-panel-height: 780px; /* ajuste aqui se quiser outra altura */
  }

  html, body {
    margin: 0;
    min-height: 100%;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, Helvetica;
    background: var(--bg);
    color: #0b1220;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* ===== LAYOUT ===== */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    min-height: 100vh;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    background: #fff;
    border-right: 1px solid #e6e9ee;
    padding: 20px 14px;
    overflow-y: auto;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  .brand { display:flex; align-items:center; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0; }
  .brand-logo { height: 56px; width: auto; display:block; }

  .sidebar .search { display:flex; align-items:center; padding-top: 8px; }
  .sidebar .search input[type="search"] {
    width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #e6e9ee; background: #fbfdff; font-size: 13px;
  }

  .nav { margin: 0; padding: 8px 4px; list-style:none; }

  .tag-item { display:block; margin-bottom:6px; border-radius:6px; cursor:pointer; font-size:13px; color:#0b1220; transition: background .12s, transform .06s; padding: 6px; }
  .tag-item:hover { background: rgba(0,0,0,0.03); transform: translateY(-1px); }
  .tag-item.active { background: linear-gradient(90deg,#eef6ff,#ffffff); border:1px solid rgba(0,47,108,0.04); }

  .tag-item.fixed .tag-head strong::after { content: " •"; color: var(--accent); font-weight:700; margin-left:6px; font-size:12px; }

  .tag-head { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .tag-head strong { font-weight:600; color: #0b1220; font-size:13px; }
  .tag-count { background: rgba(0,47,108,0.06); color: var(--brand); padding: 4px 8px; border-radius:999px; font-size:12px; }

  .ops { margin-top:8px; padding-left:6px; display:flex; flex-direction:column; gap:6px; }
  .op-link { display:flex; gap:10px; align-items:center; padding:6px 8px; border-radius:6px; font-size:13px; color:#374151; background: transparent; border: none; text-align:left; cursor:pointer; }
  .op-link:hover { background: rgba(0,0,0,0.03); }
  .op-link.active { background: rgba(0,0,0,0.04); box-shadow: inset 3px 0 0 var(--brand); color: #0b1220; font-weight:600; }

  .method-pill-left { padding:4px 8px; border-radius:6px; font-weight:700; font-size:11px; color:#fff; min-width:46px; text-align:center; }
  .method-get { background:#16a34a; }
  .method-post { background:#0ea5e9; }
  .method-put { background:#f59e0b; color:#0b1220; }
  .method-delete { background:#ef4444; }

  .op-path { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:12px; color:#6b7280; }

  /* ===== CONTENT ===== */
  .content { background: #fff; overflow: visible; }

  /* fixar a area do swagger em uma medida fixa e sem scroll interno */
  .swagger-wrapper {
    max-width: 900px;
    margin: 0 auto;
    padding: 28px 42px;
    box-sizing: border-box;
  }
  .swagger-ui {
    max-width: 900px;
    margin: 0 auto;
    padding: 0;
    box-sizing: border-box;
    height: var(--fixed-panel-height);
    overflow: visible !important; /* sem scroll interno */
  }

  /* Static documentation sections (just above swagger) */
  .doc-sections { max-width: 900px; margin: 0 auto; padding: 18px 42px 6px 42px; box-sizing: border-box; }
  .doc-section { background: #fff; border: 1px solid #eef2f6; border-radius: 8px; padding: 16px; margin-bottom: 10px; }
  .doc-section h2 { margin: 0 0 8px 0; font-size: 16px; color: #0b1220; }
  .doc-section p { margin: 0; color: #374151; font-size: 13px; }

  /* anchors offset to avoid being hidden by any top UI */
  .anchor { display:block; position: relative; top: -8px; visibility: hidden; }

  /* ===== RIGHT PANEL ===== */
  .code-panel {
    background: var(--right-bg);
    border-left: 1px solid rgba(255,255,255,0.03);
    padding: 18px;
    color: #fff;
    display:flex;
    flex-direction:column;
    gap:18px;
    height: var(--fixed-panel-height); /* altura fixa */
    box-sizing: border-box;
    position: sticky; top: 20px;
    overflow: visible; /* sem scroll interno */
  }

  .endpoint-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .endpoint-title { display:flex; align-items:center; gap:8px; }

  .method-pill { padding:6px 10px; border-radius:6px; font-weight:700; font-size:12px; color:#fff; }
  .method-pill.get { background:#16a34a; }
  .method-pill.post { background:#0ea5e9; }
  .method-pill.put { background:#f59e0b; color:#0b1220; }
  .method-pill.delete { background:#ef4444; }

  .path-text { color: rgba(255,255,255,0.95); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, monospace; font-size:13px; }

  .controls { display:flex; gap:8px; align-items:center; }
  .btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.04); color: #fff; padding:6px 8px; border-radius:8px; cursor:pointer; font-size:13px; }
  .btn.primary { background: linear-gradient(90deg,#0ea5e9,#2dd4bf); color:#06202a; font-weight:700; border:none; }

  .responses-wrapper { background: var(--right-card); border-radius:6px; padding:16px; color:#cfe8df; overflow: visible; }
  .responses-wrapper pre { background: transparent !important; border-radius: 6px; padding:0; overflow:auto; color: #9be1cc; }

  .response-badges { display:flex; gap:8px; margin-bottom:10px; }
  .response-badges .badge { padding:6px 8px; border-radius:6px; background: rgba(255,255,255,0.03); color:#cfe8df; font-weight:700; font-size:12px; }

  .panel-empty { color: rgba(255,255,255,0.6); font-size:13px; padding:8px; }

  /* Responsive: collapse right panel on narrow screens */
  @media (max-width: 1200px) {
    .layout { grid-template-columns: 260px 1fr; }
    .code-panel { display: none; }
  }
  @media (max-width: 880px) {
    .layout { grid-template-columns: 1fr; }
    .sidebar { position: fixed; left:0; top:0; bottom:0; width:76%; max-width:380px; transform: translateX(-120%); transition:transform .22s; z-index:90; box-shadow:8px 0 32px rgba(2,6,23,0.12); }
    .sidebar.open { transform: translateX(0); }
  }

  .muted { color: var(--muted); font-size:12px; }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar" role="navigation" aria-label="Sidebar">
    <div class="brand" aria-hidden="false">
      <img src="https://developers-sandbox.bvopen.com.br/sites/default/files/apidoc_specs/API-PIX-V1/assets/images/logo.png" alt="Banco BV" class="brand-logo" />
    </div>

    <div class="search" aria-hidden="false">
      <input id="sidebar-search" type="search" placeholder="Search..." aria-label="Buscar" />
    </div>

    <nav>
      <ul id="sidebar-menu" class="nav" aria-live="polite" aria-label="Lista de tags"></ul>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="content">

    <!-- STATIC DOCUMENTATION SECTIONS (ADDED) -->
    <div class="doc-sections" id="doc-sections">
      <!-- Sections injected by script -->
    </div>

    <div class="swagger-wrapper">
      <div id="swagger-ui" class="swagger-ui"></div>
    </div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <div class="endpoint-header">
      <div class="endpoint-title">
        <span id="code-method" class="method-pill default">OP</span>
        <div id="code-path" class="path-text">/caminho/exemplo</div>
      </div>
      <div class="controls">
        <button id="code-copy" class="btn">Copiar</button>
        <button id="code-open" class="btn">Ir ao endpoint</button>
      </div>
    </div>

    <div id="code-view"><div class="panel-empty">Abra uma operação (clicando em um endpoint) para ver exemplos de respostas e códigos aqui.</div></div>
  </aside>

</div>

<!-- scripts -->
<script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<script>
/*
  Final behavior implemented:
  - Swagger UI and right code panel have fixed heights (CSS variable --fixed-panel-height).
  - No internal scrollbars inside those panels (overflow: visible). The document/page will scroll instead.
  - Sidebar is merged: the provided FIXED list is rendered first (as fixed sidebar items). Each fixed item:
      * If a matching Swagger tag exists, its operations are shown nested under that fixed item.
      * If no Swagger tag is found, the fixed item links to an external/document fragment URL:
          BASE_DOC_URL + '#section/' + sanitized-name  (example you requested).
      * If the fixed item name matches a swagger tag, the tag link uses '#tag/<TagName>' as fragment (per your example).
  - Each static H2 section is injected above the Swagger UI so '#section/...' targets exist on the page.
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";
const BASE_DOC_URL = "https://developers-sandbox.bvopen.com.br/api/pix"; // used for section links when no matching tag
let lastClickedOpblock = null;

/* --- LIST OF FIXED TAGS (user-provided) --- */
const FIXED_TAGS = [
  "O que é o Pix?",
  "SLAs",
  "Idempotência",
  "Releases",
  "Operacional",
  "Fluxos de tentativas no envio de pagamentos",
  "Location",
  "Gerenciamento de cobranças para pagamento imediato",
  "Gerenciamento de cobranças com vencimento",
  "Gerenciamento de cobranças com vencimento em lote",
  "Notificação",
  "Gerenciamento de Pix recebidos",
  "Gerenciamento de Pix enviados",
  "DICT",
  "Notificação de Infração",
  "QRCode",
  "Reúne endpoints (locations) que retornam o Payload JSON que representa uma Cobrança",
  "Solicitação de Devolução Especial",
  "Pix Saque e Pix Troco",
  "Participantes SPI",
  "Gerenciamento de Notificações - Webhook",
  "Iniciação de Pagamento",
  "Políticas",
  "Antifraude",
  "Agendamentos",
  "Pix Automático",
  "Recuperação de Valores",
  "Autenticação e Segurança",
  "Iniciação Open Finance - ITP"
];

/* --- Helper utilities --- */
const $qsa = (s, scope = document) => Array.from((scope || document).querySelectorAll(s));
const $qs = (s, scope = document) => (scope || document).querySelector(s);

function waitForSwaggerReady(timeout = 12000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    (function check() {
      if ($qsa('.opblock-tag').length > 0) return resolve();
      if (Date.now() - start > timeout) return reject(new Error('Swagger UI did not render in time'));
      requestAnimationFrame(check);
    })();
  });
}

/* Normalize for matching swagger tag names (remove diacritics, trim, lowercase) */
function normalizeTagName(n) {
  return String(n || '').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
}

/* Build the fragment used for '#section/...' per your examples:
   - remove diacritics and punctuation, replace spaces with '-', preserve case from original label
   Example: "O que é o Pix?" -> "O-que-e-o-Pix" */
function sectionFragmentFromName(name) {
  const noDiacrit = String(name || '')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // remove punctuation except spaces and hyphens
  const cleaned = noDiacrit.replace(/[?!.,:;()"\[\]\/\\’'“”`«»]/g, '').trim();
  const withDashes = cleaned.replace(/\s+/g, '-');
  return withDashes;
}

/* Inject static H2 sections above Swagger UI so '#section/...' targets exist */
function injectStaticSections() {
  const container = document.getElementById('doc-sections');
  if (!container) return;
  container.innerHTML = '';
  FIXED_TAGS.forEach(name => {
    const frag = sectionFragmentFromName(name);
    const section = document.createElement('section');
    section.className = 'doc-section';
    // anchor id uses format "section/<Frag>" so example fragment becomes '#section/O-que-e-o-Pix'
    const anchorSpan = document.createElement('span');
    anchorSpan.className = 'anchor';
    // create id with prefix to allow document.getElementById on both "section/O-..." and "section-..."
    // but HTML id cannot contain '/', so set two anchors: one with id "section-<frag>" and data-fragment for easy lookup
    const idSafe = 'section-' + frag;
    anchorSpan.id = idSafe;
    section.appendChild(anchorSpan);

    const h2 = document.createElement('h2');
    h2.textContent = name;
    section.appendChild(h2);

    const p = document.createElement('p');
    p.className = 'muted';
    p.textContent = 'Conteúdo de documentação para "' + name + '". Adicione aqui descrições, regras e exemplos relevantes.';
    section.appendChild(p);

    // expose a data attribute to compute the external fragment '#section/<Frag>' when building sidebar links
    section.dataset.sectionFragment = frag;

    container.appendChild(section);
  });
}

/* Initialize Swagger UI */
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true,
  presets: [SwaggerUIBundle.presets.apis]
});

/* Build sidebar merging FIXED_TAGS and auto-generated swagger tags/ops */
function buildSidebar() {
  const menu = document.getElementById('sidebar-menu');
  menu.innerHTML = '';

  // map swagger tags by normalized name for quick lookup
  const swaggerTagEls = $qsa('.opblock-tag');
  const tagMap = new Map(); // normName -> { el: tagEl, title, ops: [opElements] }
  swaggerTagEls.forEach(tagEl => {
    const titleSpan = tagEl.querySelector('h3 span');
    if (!titleSpan) return;
    const titleText = titleSpan.textContent.trim();
    const norm = normalizeTagName(titleText);
    const ops = Array.from(tagEl.querySelectorAll('.opblock-summary'));
    tagMap.set(norm, { el: tagEl, title: titleText, ops });
  });

  const processed = new Set();

  // 1) Render fixed tags in the provided order
  FIXED_TAGS.forEach(fixedName => {
    const norm = normalizeTagName(fixedName);
    const found = tagMap.get(norm);
    const li = document.createElement('li');
    li.className = 'tag-item fixed';
    li.tabIndex = 0;

    const head = document.createElement('div');
    head.className = 'tag-head';

    // Build the right-side count (if swagger tag found, show op count; otherwise 0)
    const count = found ? found.ops.length : 0;

    // Build a link element: if swagger tag exists, link to '#tag/<TagName>'; otherwise to BASE_DOC_URL + '#section/<Frag>'
    const left = document.createElement('div');
    const right = document.createElement('div');

    left.innerHTML = `<strong>${escapeHtml(fixedName)}</strong>`;
    right.className = 'tag-count';
    right.textContent = count;

    head.appendChild(left);
    head.appendChild(right);

    li.appendChild(head);

    // ops container (if swagger ops available, list them)
    const opsContainer = document.createElement('div');
    opsContainer.className = 'ops';

    if (found && found.ops.length) {
      found.ops.forEach(op => {
        const method = op.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
        const path = op.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
        const btn = document.createElement('button');
        btn.className = 'op-link';
        btn.type = 'button';
        btn.innerHTML = `<div class="method-pill-left method-${escapeHtml(method.toLowerCase())}">${escapeHtml(method)}</div>
                         <div style="display:flex;flex-direction:column;align-items:flex-start;">
                           <div style="font-size:13px;color:#0b1220;">${escapeHtml(path)}</div>
                           <div class="op-path" style="margin-top:2px">${escapeHtml(path)}</div>
                         </div>`;
        btn.addEventListener('click', () => {
          const opblock = op.closest('.opblock');
          if (!opblock) return;
          const summary = opblock.querySelector('.opblock-summary');
          if (summary) {
            summary.scrollIntoView({ behavior: 'smooth', block: 'center' });
            summary.click();
            lastClickedOpblock = opblock;
            setTimeout(() => updateRightPanel(opblock), 220);
          }
        });
        opsContainer.appendChild(btn);
      });

      // clicking the tag head scrolls to the swagger tag
      head.addEventListener('click', () => {
        // collapse others
        Array.from(menu.children).forEach(n => n.classList.remove('active'));
        li.classList.add('active');

        if (found && found.el) {
          found.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    } else {
      // no swagger ops: make the head a link to the external section fragment
      const frag = sectionFragmentFromName(fixedName);
      const externalFragment = `#section/${frag}`; // fragment portion for the external doc URL
      // Clicking the head will navigate to BASE_DOC_URL#section/<frag>
      head.addEventListener('click', () => {
        // full navigation: if current page is the same as BASE_DOC_URL, try to scroll to the injected on-page anchor
        const pageIsBase = location.href.startsWith(BASE_DOC_URL);
        if (pageIsBase) {
          // find injected section with matching fragment (we created id 'section-<frag>')
          const anchorId = 'section-' + frag;
          const anchorEl = document.getElementById(anchorId);
          if (anchorEl) {
            anchorEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
          }
        }
        // otherwise navigate to external doc + fragment
        location.href = BASE_DOC_URL + externalFragment;
      });

      // show a placeholder op telling user it's a doc link
      const placeholder = document.createElement('div');
      placeholder.className = 'muted';
      placeholder.style.padding = '6px 8px';
      placeholder.innerHTML = `Veja a documentação: <a href="${BASE_DOC_URL}#section/${frag}" target="_blank" rel="noopener" style="color:var(--brand)">Ir para seção</a>`;
      opsContainer.appendChild(placeholder);
    }

    li.appendChild(opsContainer);
    menu.appendChild(li);

    if (found) processed.add(norm);
  });

  // 2) Render remaining swagger tags (those not in FIXED_TAGS)
  for (const [norm, info] of tagMap.entries()) {
    if (processed.has(norm)) continue;
    const titleText = info.title;
    const operations = info.ops;
    const li = document.createElement('li');
    li.className = 'tag-item';
    li.tabIndex = 0;

    const head = document.createElement('div');
    head.className = 'tag-head';
    head.innerHTML = `<strong>${escapeHtml(titleText)}</strong><div class="tag-count">${operations.length}</div>`;
    li.appendChild(head);

    const opsContainer = document.createElement('div');
    opsContainer.className = 'ops';

    operations.forEach(op => {
      const method = op.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
      const path = op.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
      const btn = document.createElement('button');
      btn.className = 'op-link';
      btn.type = 'button';
      btn.innerHTML = `<div class="method-pill-left method-${escapeHtml(method.toLowerCase())}">${escapeHtml(method)}</div>
                       <div style="display:flex;flex-direction:column;align-items:flex-start;">
                         <div style="font-size:13px;color:#0b1220;">${escapeHtml(path)}</div>
                         <div class="op-path" style="margin-top:2px">${escapeHtml(path)}</div>
                       </div>`;

      btn.addEventListener('click', () => {
        const opblock = op.closest('.opblock');
        if (!opblock) return;
        const summary = opblock.querySelector('.opblock-summary');
        if (summary) {
          summary.scrollIntoView({ behavior: 'smooth', block: 'center' });
          summary.click();
          lastClickedOpblock = opblock;
          setTimeout(() => updateRightPanel(opblock), 220);
        }
      });

      opsContainer.appendChild(btn);
    });

    head.addEventListener('click', () => {
      Array.from(menu.children).forEach(n => n.classList.remove('active'));
      li.classList.add('active');
      if (info.el) info.el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    li.appendChild(opsContainer);
    menu.appendChild(li);
  }
}

/* Highlight corresponding op in the sidebar */
function highlightSidebarOp(opblock) {
  if (!opblock) return;
  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

  const ops = $qsa('#sidebar-menu .op-link');
  ops.forEach(op => {
    const text = op.textContent || '';
    const isMatch = text.includes(path) && text.includes(method);
    op.classList.toggle('active', isMatch);
    if (isMatch) {
      const tagItem = op.closest('.tag-item');
      if (tagItem) {
        Array.from(document.querySelectorAll('#sidebar-menu .tag-item')).forEach(t => t.classList.remove('active'));
        tagItem.classList.add('active');
      }
    }
  });
}

/* Find responses/examples area inside an opblock reliably */
function findResponsesWrapper(opblockEl) {
  if (!opblockEl) return null;
  let node = opblockEl.querySelector('.responses-wrapper') || opblockEl.querySelector('.opblock-body .responses-wrapper') || opblockEl.querySelector('.opblock-section .responses-wrapper');
  if (node) return node;
  const pre = opblockEl.querySelector('pre');
  if (pre) {
    const wrapper = document.createElement('div');
    wrapper.className = 'responses-wrapper';
    wrapper.appendChild(pre.cloneNode(true));
    return wrapper;
  }
  return null;
}

/* Update right panel with cloned responses */
function updateRightPanel(preferredOpblock) {
  const panel = document.getElementById('code-view');
  panel.innerHTML = '';

  let opblock = preferredOpblock || lastClickedOpblock || document.querySelector('.opblock.is-open');
  if (!opblock) {
    panel.innerHTML = '<div class="panel-empty">Abra uma operação (clicando em um endpoint) para ver exemplos de respostas e códigos aqui.</div>';
    return;
  }

  const method = opblock.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblock.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

  const codeMethodEl = document.getElementById('code-method');
  codeMethodEl.className = 'method-pill ' + (method ? method.toLowerCase() : 'default');
  codeMethodEl.textContent = method || 'OP';
  document.getElementById('code-path').textContent = path || '';

  let responses = findResponsesWrapper(opblock);

  if (!responses && !opblock.classList.contains('is-open')) {
    setTimeout(() => updateRightPanel(opblock), 240);
    panel.innerHTML = '<div class="panel-empty">Carregando exemplos...</div>';
    return;
  }

  if (!responses) {
    panel.innerHTML = '<div class="panel-empty">Nenhuma resposta de exemplo encontrada para este endpoint.</div>';
    return;
  }

  const clone = responses.cloneNode(true);
  clone.classList.add('responses-wrapper');
  clone.querySelectorAll('.try-out, .execute, .btn, .model, .responses-request, .parameters, .tab, .tabbed').forEach(n => n.remove());
  clone.querySelectorAll('pre, code').forEach(el => { el.style.whiteSpace = 'pre'; el.style.wordBreak = 'break-word'; el.classList.add('hljs'); });

  const badges = document.createElement('div');
  badges.className = 'response-badges';
  badges.innerHTML = `<div class="badge">200</div><div class="badge">403</div><div class="badge">503</div>`;
  panel.appendChild(badges);
  panel.appendChild(clone);

  panel.querySelectorAll('pre code').forEach(block => { try { hljs.highlightElement(block); } catch(e){} });

  const copyBtn = document.getElementById('code-copy');
  copyBtn.onclick = async () => {
    let text = '';
    const codes = panel.querySelectorAll('pre code');
    if (codes.length) text = Array.from(codes).map(c => c.innerText).join('\n\n---\n\n');
    else text = panel.innerText;
    try { await navigator.clipboard.writeText(text); copyBtn.textContent = 'Copiado ✓'; setTimeout(() => copyBtn.textContent = 'Copiar', 1200); }
    catch { copyBtn.textContent = 'Erro'; setTimeout(() => copyBtn.textContent = 'Copiar', 1200); }
  };

  const openBtn = document.getElementById('code-open');
  openBtn.onclick = () => {
    opblock.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const prev = opblock.style.boxShadow;
    opblock.style.boxShadow = '0 10px 36px rgba(14,165,233,0.12)';
    setTimeout(() => opblock.style.boxShadow = prev || '', 900);
  };
}

/* Escape HTML for safe insertion */
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* Observe swagger tree mutations to rebuild sidebar when needed */
function observeOpblockOpenEvents() {
  const uiRoot = document.querySelector('.swagger-ui');
  if (!uiRoot) return;

  const mo = new MutationObserver(mutations => {
    for (const m of mutations) {
      if (m.type === 'attributes' && m.attributeName === 'class') {
        const target = m.target;
        if (target.classList && target.classList.contains('opblock') && target.classList.contains('is-open')) {
          const preferred = lastClickedOpblock || target;
          setTimeout(() => updateRightPanel(preferred), 80);
          highlightSidebarOp(preferred);
        }
      }
      if (m.addedNodes && m.addedNodes.length) {
        // debounce rebuild
        clearTimeout(window._rebuild_sidebar);
        window._rebuild_sidebar = setTimeout(() => {
          buildSidebar();
        }, 160);
      }
    }
  });

  mo.observe(uiRoot, { subtree: true, childList: true, attributes: true, attributeFilter: ['class'] });
}

/* Bind clicks inside swagger area to capture op open events */
function bindEndpointClicks() {
  const container = document.getElementById('swagger-ui');
  if (!container) return;
  container.addEventListener('click', (e) => {
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    lastClickedOpblock = opblock;
    setTimeout(() => updateRightPanel(opblock), 220);
  });
  container.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    lastClickedOpblock = opblock;
    setTimeout(() => updateRightPanel(opblock), 220);
  });
}

/* Wait for swagger, then inject sections and build merged sidebar */
(async function init() {
  try {
    // inject static doc sections so '#section/<frag>' anchors exist locally
    injectStaticSections();

    await waitForSwaggerReady();

    // initial build
    buildSidebar();
    bindEndpointClicks();
    observeOpblockOpenEvents();

    // if some opblock is already open, populate right panel
    setTimeout(() => {
      const open = document.querySelector('.opblock.is-open');
      if (open) {
        lastClickedOpblock = open;
        updateRightPanel(open);
        highlightSidebarOp(open);
      }
    }, 300);
  } catch (err) {
    console.warn('Erro inicializando UI melhorada:', err);
  }
})();
</script>
</body>
</html>
