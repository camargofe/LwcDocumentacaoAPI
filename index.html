<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIX API - Banco BV</title>

<link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css" />

<style>
  :root{
    --sidebar-width: 300px;
    --right-width: 520px;
    --brand: #0b3b66;
    --accent: #0ea5e9;
    --muted: #6b7280;
    --bg: #f5f7fa;
    --panel-bg: linear-gradient(180deg,#071422,#03101b);
  }

  html,body{
    height:100%;
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: var(--bg);
    color: #0b1220;
    -webkit-font-smoothing:antialiased;
  }

  /* GRID LAYOUT - three columns */
  .layout {
    display: grid;
    grid-template-columns: var(--sidebar-width) 1fr var(--right-width);
    gap: 0;
    height: 100vh;
  }

  /* ---------------- SIDEBAR ---------------- */
  .sidebar{
    background: #fff;
    border-right:1px solid #e6e9ee;
    padding: 18px;
    display:flex;
    flex-direction:column;
    gap:14px;
    overflow:auto;
  }

  .site-brand {
    display:flex;
    gap:12px;
    align-items:center;
  }

  .brand-title{
    font-weight:700;
    color:var(--brand);
    font-size:16px;
    margin:0;
  }

  .brand-sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }

  .search {
    margin-top:6px;
  }

  .search input{
    width:100%;
    padding:8px 10px;
    border-radius:8px;
    border:1px solid #e6e9ee;
    background:#fbfdff;
    font-size:13px;
  }

  .tag-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }

  .tag {
    background: #fafbfc;
    border-radius:10px;
    padding:8px;
    border:1px solid transparent;
    transition: box-shadow .12s, transform .06s, border-color .12s;
  }
  .tag:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(10,20,40,0.04); border-color: rgba(11,59,102,0.06); }

  .tag-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    cursor:pointer;
  }

  .tag-title { font-size:14px; color:var(--brand); font-weight:600; }
  .tag-count { background: rgba(11,59,102,0.06); color:var(--brand); padding:3px 8px; border-radius:999px; font-size:12px; }

  .tag-ops {
    margin-top:8px;
    display:none;
    flex-direction:column;
    gap:6px;
  }

  .tag.open .tag-ops { display:flex; }

  .op-item {
    display:flex;
    gap:8px;
    align-items:center;
    padding:6px 8px;
    border-radius:8px;
    font-size:13px;
    cursor:pointer;
    color:#0b1220;
    background:transparent;
    border:1px solid transparent;
  }

  .op-item:hover { background: rgba(11,59,102,0.04); transform: translateY(-1px); border-color: rgba(11,59,102,0.03); }

  .op-method {
    min-width:52px;
    text-align:center;
    padding:4px 8px;
    border-radius:999px;
    font-weight:700;
    font-size:12px;
    color:#fff;
  }
  .op-method.get { background:#16a34a; }
  .op-method.post { background:#0ea5e9; color:#06202a; }
  .op-method.put { background:#f59e0b; color:#0b1220; }
  .op-method.delete { background:#ef4444; }

  .op-path { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  .sidebar-footer { margin-top:auto; font-size:12px; color:var(--muted); }

  /* ---------------- CONTENT ---------------- */
  .content { background:#fff; overflow:auto; position:relative; }
  .swagger-ui { padding:20px; }

  /* ---------------- RIGHT PANEL ---------------- */
  .code-panel{
    background: var(--panel-bg);
    color:#fff;
    padding:18px;
    border-left:1px solid rgba(255,255,255,0.03);
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:auto;
  }

  .endpoint-header{ display:flex; justify-content:space-between; gap:12px; align-items:center; }
  .endpoint-info { display:flex; gap:12px; align-items:center; }
  .endpoint-title { font-weight:700; font-size:14px; color:#fff; }

  .path-text { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:13px; color:rgba(255,255,255,0.92); }

  .controls { display:flex; gap:8px; align-items:center; }
  .btn { padding:7px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background: rgba(255,255,255,0.04); color:#fff; cursor:pointer; font-size:13px; }
  .btn.primary { background: linear-gradient(90deg,var(--accent),#2dd4bf); color:#06202a; border:none; font-weight:700; }

  .responses-wrapper pre, .responses-wrapper code {
    background:#020617 !important;
    border-radius:8px;
    padding:12px;
    overflow:auto;
    font-size:13px;
  }

  .panel-empty { color: rgba(255,255,255,0.6); font-size:13px; padding:8px; }

  /* small spinner */
  .spinner {
    border: 3px solid rgba(255,255,255,0.06);
    border-top: 3px solid rgba(255,255,255,0.18);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    animation: spin .9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Responsive adjustments */
  @media (max-width:1200px){
    .layout { grid-template-columns:260px 1fr; }
    .code-panel { display:none; }
  }

  @media (max-width:880px){
    .layout { grid-template-columns:1fr; }
    .sidebar { position:fixed; left:0; top:0; bottom:0; width:76%; max-width:380px; transform:translateX(-120%); transition:transform .22s; z-index:90; box-shadow:8px 0 32px rgba(2,6,23,0.12); }
    .sidebar.open { transform:translateX(0); }
  }
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="site-brand">
      <div>
        <h1 class="brand-title">PIX API</h1>
        <div class="brand-sub">PIX API - Banco BV</div>
      </div>
    </div>

    <div class="search">
      <input id="sidebar-search" type="search" placeholder="Buscar tag, caminho ou operação..." aria-label="Buscar na documentação">
    </div>

    <ul id="sidebar-menu" class="tag-list" aria-live="polite" aria-label="Lista de tags">
      <!-- tags + submenus populated dynamically -->
    </ul>

    <div id="tag-meta" class="sidebar-footer">Open Banking · <strong>openbanking@bv.com.br</strong></div>
  </aside>

  <!-- CONTENT -->
  <main class="content" id="content">
    <div id="swagger-ui" class="swagger-ui"></div>
  </main>

  <!-- RIGHT PANEL -->
  <aside class="code-panel" id="code-panel" aria-live="polite" aria-atomic="true">
    <div class="endpoint-header">
      <div class="endpoint-info">
        <div id="code-method" class="op-method method-pill default" style="display:none"></div>
        <div class="endpoint-title" id="code-title">Abra um endpoint</div>
      </div>
      <div class="controls">
        <div id="panel-spinner" class="spinner" style="display:none"></div>
        <button id="code-copy" class="btn">Copiar</button>
        <button id="code-open" class="btn">Ir ao endpoint</button>
      </div>
    </div>

    <div id="code-view">
      <div class="panel-empty">Abra uma operação (clicando em um endpoint ou no submenu) para ver exemplos de respostas e códigos aqui.</div>
    </div>
  </aside>

</div>

<!-- scripts -->
<script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>

<script>
/*
  Improvements in this version:
  - Sidebar now contains tags AND submenus (operations) and supports expand/collapse.
  - Performance optimizations:
    - Build sidebar as soon as Swagger renders tags using MutationObserver (no fixed timeout).
    - Debounced rebuilds on changes.
    - Lazy-load highlight.js only when first code example is shown.
    - Minimize repeated DOM queries; use delegation and caches where practical.
  - Keep existing behavior: user clicks summary (native Swagger) or clicks submenu (programmatically clicks summary),
    and the right panel displays cloned responses/examples.
  - Right panel shows spinner while content is being rendered/cloned to improve UX.
*/

const SWAGGER_URL = "https://camargofe.github.io/LwcDocumentacaoAPI/pix.yaml";

/* Initialize Swagger UI (no blocking) */
SwaggerUIBundle({
  url: SWAGGER_URL,
  dom_id: "#swagger-ui",
  layout: "BaseLayout",
  deepLinking: true,
  presets: [SwaggerUIBundle.presets.apis]
});

/* Utilities */
const $ = (s, ctx = document) => ctx.querySelector(s);
const $$ = (s, ctx = document) => Array.from((ctx || document).querySelectorAll(s));
const debounce = (fn, wait = 120) => {
  let t;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
};

let hljsLoaded = false;
let hljsLoading = false;

/* Lazy-load highlight.js on demand */
function ensureHljs() {
  return new Promise((resolve) => {
    if (hljsLoaded) return resolve(window.hljs);
    if (hljsLoading) {
      // wait until loaded
      const interval = setInterval(() => {
        if (hljsLoaded) { clearInterval(interval); resolve(window.hljs); }
      }, 80);
      return;
    }
    hljsLoading = true;
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js";
    script.onload = () => {
      hljsLoaded = true;
      hljsLoading = false;
      resolve(window.hljs);
    };
    script.onerror = () => {
      hljsLoading = false;
      resolve(null);
    };
    document.head.appendChild(script);
    // optional CSS for dark style (only once)
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css';
    document.head.appendChild(link);
  });
}

/* Wait for Swagger UI to render opblock-tag elements using MutationObserver (faster & more robust) */
function waitForSwaggerReady(timeout = 12000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    const root = document.getElementById('swagger-ui');
    if (!root) return reject(new Error('swagger-ui container not found'));

    const observer = new MutationObserver(() => {
      if ($$('.opblock-tag').length > 0) {
        observer.disconnect();
        resolve();
      } else if (Date.now() - start > timeout) {
        observer.disconnect();
        reject(new Error('Timeout waiting for Swagger UI to render'));
      }
    });

    observer.observe(root, { childList: true, subtree: true });

    // Also do an immediate check in case it's already rendered
    if ($$('.opblock-tag').length > 0) {
      observer.disconnect();
      resolve();
    }
  });
}

/* Build sidebar: tags with collapsible submenus of operations */
function buildSidebar() {
  const menu = document.getElementById('sidebar-menu');
  menu.innerHTML = '';

  const tags = $$('.opblock-tag');
  tags.forEach(tagEl => {
    const titleSpan = tagEl.querySelector('h3 span');
    const tagName = titleSpan ? titleSpan.textContent.trim() : 'Sem nome';
    const opblocks = tagEl.querySelectorAll('.opblock');

    // Tag container
    const li = document.createElement('li');
    li.className = 'tag';
    li.setAttribute('data-tag', tagName);

    // Header (click toggles)
    const header = document.createElement('div');
    header.className = 'tag-header';
    header.setAttribute('role', 'button');
    header.setAttribute('aria-expanded', 'false');
    header.tabIndex = 0;

    const tleft = document.createElement('div');
    tleft.className = 'tag-title';
    tleft.textContent = tagName;

    const tright = document.createElement('div');
    tright.className = 'tag-count';
    tright.textContent = opblocks.length;

    header.appendChild(tleft);
    header.appendChild(tright);

    // operations submenu
    const ops = document.createElement('div');
    ops.className = 'tag-ops';

    opblocks.forEach(op => {
      const summary = op.querySelector('.opblock-summary');
      if (!summary) return;

      const method = summary.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
      const path = summary.querySelector('.opblock-summary-path')?.textContent?.trim() || '';

      const opBtn = document.createElement('button');
      opBtn.className = 'op-item';
      opBtn.type = 'button';
      opBtn.title = `${method} ${path}`;

      const mspan = document.createElement('div');
      mspan.className = `op-method ${method.toLowerCase()}`;
      mspan.textContent = method;

      const pspan = document.createElement('div');
      pspan.className = 'op-path';
      pspan.textContent = path;

      opBtn.appendChild(mspan);
      opBtn.appendChild(pspan);

      // When clicking submenu, scroll to the op and trigger the same behavior as user clicking summary
      opBtn.addEventListener('click', (ev) => {
        ev.preventDefault();
        // smooth scroll and then click the summary (programmatic click)
        summary.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // give a tiny delay to allow scroll to settle
        setTimeout(() => {
          // Programmatic click - Swagger will toggle .is-open; our observer picks that up and clones examples
          summary.click();
          // update active tag visually
          setActiveTag(tagName);
        }, 180);
      });

      ops.appendChild(opBtn);
    });

    // toggle behavior for tag header
    const toggleTag = () => {
      const isOpen = li.classList.toggle('open');
      header.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    };

    header.addEventListener('click', toggleTag);
    header.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleTag(); } });

    li.appendChild(header);
    li.appendChild(ops);
    menu.appendChild(li);
  });
}

/* highlight active tag based on viewport using IntersectionObserver (keeps sidebar in sync) */
function wireActiveTagHighlighting() {
  const tags = $$('.opblock-tag');
  if (!tags.length) return;

  const options = { root: document.querySelector('.content'), rootMargin: '0px 0px -60% 0px', threshold: [0.1, 0.4] };
  const obs = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const name = entry.target.querySelector('h3 span')?.textContent?.trim();
        if (name) setActiveTag(name);
      }
    });
  }, options);

  tags.forEach(t => obs.observe(t));
}

function setActiveTag(name) {
  const all = document.querySelectorAll('#sidebar-menu .tag');
  all.forEach(li => li.classList.toggle('active', li.getAttribute('data-tag') === name));
  const meta = document.getElementById('tag-meta');
  meta.textContent = name ? `Exibindo endpoints para: ${name}` : 'Selecione uma tag para navegar rapidamente.';
}

/* Find responses/examples inside an opblock robustly */
function findResponsesWrapper(opblockEl) {
  if (!opblockEl) return null;
  // common places
  let node = opblockEl.querySelector('.responses-wrapper');
  if (node) return node;
  node = opblockEl.querySelector('.opblock-body .responses-wrapper');
  if (node) return node;
  node = opblockEl.querySelector('.opblock-section .responses-wrapper');
  if (node) return node;

  // fallback: look for <pre> elements inside opblock
  const pre = opblockEl.querySelector('pre');
  if (pre) {
    const wrapper = document.createElement('div');
    wrapper.className = 'responses-wrapper';
    wrapper.appendChild(pre.cloneNode(true));
    return wrapper;
  }

  return null;
}

/* Show spinner in right panel */
function showSpinner(show = true) {
  const s = document.getElementById('panel-spinner');
  s.style.display = show ? '' : 'none';
}

/* Update right panel: clone the responses for the opblock into the panel */
async function updateRightPanelFor(opblockEl) {
  const panel = document.getElementById('code-view');
  panel.innerHTML = '';

  if (!opblockEl) {
    panel.innerHTML = '<div class="panel-empty">Abra uma operação para ver exemplos de respostas e códigos aqui.</div>';
    return;
  }

  // header
  const method = opblockEl.querySelector('.opblock-summary-method')?.textContent?.trim() || '';
  const path = opblockEl.querySelector('.opblock-summary-path')?.textContent?.trim() || '';
  const title = document.getElementById('code-title');
  title.textContent = `${method} ${path}`;

  // show spinner while we try to find/clone the responses
  showSpinner(true);

  // Wait briefly to allow Swagger to render the response area if it was just opened
  await new Promise(r => setTimeout(r, 180));

  let responses = findResponsesWrapper(opblockEl);

  // If not found and the opblock is NOT open, it's possible the user clicked programmatically and content is still rendering;
  // attempt one last retry after small delay
  if (!responses && !opblockEl.classList.contains('is-open')) {
    await new Promise(r => setTimeout(r, 160));
    responses = findResponsesWrapper(opblockEl);
  }

  showSpinner(false);

  if (!responses) {
    // Nothing rendered - show helpful message and attempt to show inline pre blocks if any
    const inlinePre = opblockEl.querySelectorAll('pre');
    if (inlinePre && inlinePre.length) {
      inlinePre.forEach(p => panel.appendChild(p.cloneNode(true)));
      await ensureHljs().then((hljs) => {
        panel.querySelectorAll('pre code').forEach(b => { try { hljs?.highlightElement(b); } catch(e){} });
      });
      return;
    }

    panel.innerHTML = '<div class="panel-empty">Nenhuma resposta de exemplo encontrada para este endpoint.</div>';
    return;
  }

  // Clone and sanitize clone
  const clone = responses.cloneNode(true);
  // remove interactive controls that are not useful in the side panel
  clone.querySelectorAll('.try-out, .execute, .btn, .model, .responses-request, .parameters').forEach(n => n.remove());

  // normalize code blocks
  clone.querySelectorAll('pre, code').forEach(el => {
    el.style.whiteSpace = 'pre';
    el.style.wordBreak = 'break-word';
    el.classList.add('hljs');
  });

  panel.appendChild(clone);

  // lazy highlight
  await ensureHljs().then((hljs) => {
    panel.querySelectorAll('pre code').forEach(block => {
      try { hljs?.highlightElement(block); } catch(e) {}
    });
  });
}

/* Observe opblock opens and also rebuild sidebar when Swagger re-renders content */
function attachObservers() {
  const uiRoot = document.getElementById('swagger-ui');
  if (!uiRoot) return;

  const mo = new MutationObserver((mutations) => {
    let rebuild = false;
    for (const m of mutations) {
      // If opblock classes changed (opened), handle that
      if (m.type === 'attributes' && m.attributeName === 'class' && m.target.classList && m.target.classList.contains('opblock')) {
        const el = m.target;
        if (el.classList.contains('is-open')) {
          // When opblock becomes open, clone its responses into the right panel
          // small delay so content is rendered
          setTimeout(() => updateRightPanelFor(el), 120);
        }
      }

      // New nodes added (Swagger re-render) -> rebuild sidebar (debounced)
      if (m.addedNodes && m.addedNodes.length) rebuild = true;
    }

    if (rebuild) {
      debouncedBuildSidebar();
    }
  });

  mo.observe(uiRoot, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
}

/* Debounced sidebar builder */
const debouncedBuildSidebar = debounce(() => {
  buildSidebar();
  wireActiveTagHighlighting();
}, 180);

/* Setup click delegation for swagger container - capture user's manual clicks too (keyboard accessible) */
function bindUserClicks() {
  const container = document.getElementById('swagger-ui');
  if (!container) return;

  container.addEventListener('click', (e) => {
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    // Delay slightly for Swagger to toggle is-open and render examples
    setTimeout(() => updateRightPanelFor(opblock), 220);
  });

  container.addEventListener('keydown', (e) => {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    const summary = e.target.closest('.opblock-summary');
    if (!summary) return;
    const opblock = summary.closest('.opblock');
    if (!opblock) return;
    setTimeout(() => updateRightPanelFor(opblock), 220);
  });
}

/* Sidebar search: filter tags & operations */
function initSidebarSearch() {
  const input = document.getElementById('sidebar-search');
  input.addEventListener('input', debounce(() => {
    const q = input.value.trim().toLowerCase();
    const tags = document.querySelectorAll('#sidebar-menu .tag');
    tags.forEach(tag => {
      const tagName = tag.getAttribute('data-tag') || '';
      const opItems = tag.querySelectorAll('.op-item');
      let tagMatch = !q || tagName.toLowerCase().includes(q);
      let anyOpMatch = false;
      opItems.forEach(op => {
        const text = op.title.toLowerCase();
        const match = !q || text.includes(q);
        op.style.display = match ? '' : 'none';
        if (match) anyOpMatch = true;
      });
      // Show the tag if tag name matches or any op matches
      tag.style.display = (tagMatch || anyOpMatch) ? '' : 'none';
      // expand if any op matched (helpful UX)
      if (anyOpMatch && !tag.classList.contains('open')) tag.classList.add('open');
      if (!anyOpMatch && !tagMatch) tag.classList.remove('open');
    });
  }, 180));
}

/* Entry point: wait for Swagger UI, then wire everything */
(async function init() {
  try {
    await waitForSwaggerReady();

    // initial build and wiring
    buildSidebar();
    wireActiveTagHighlighting();
    attachObservers();
    bindUserClicks();
    initSidebarSearch();

    // If some opblock already open, show it in right panel
    setTimeout(() => {
      const opened = document.querySelector('.opblock.is-open');
      if (opened) updateRightPanelFor(opened);
    }, 300);

    // Rebuild sidebar if Swagger re-renders later
    const uiRoot = document.getElementById('swagger-ui');
    if (uiRoot) {
      const mo = new MutationObserver(debouncedBuildSidebar);
      mo.observe(uiRoot, { childList: true, subtree: true });
    }
  } catch (err) {
    console.warn('Erro ao inicializar a UI aprimorada:', err);
  }
})();
</script>
</body>
</html>
